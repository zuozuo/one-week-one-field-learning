# Tools（工具）详解

## 什么是 Tools？

**一句话定义**：Tools 是 AI 可以调用的"技能"，让 AI 能够实际操作你的代码和系统。

### 生活类比

AI 就像一个聪明的大脑，但没有手脚就什么也做不了。Tools 就是 AI 的"手脚"：

| 你想让 AI 做的事 | AI 需要的工具 |
|----------------|-------------|
| 看看代码写了啥 | read（读文件） |
| 写一个新文件 | write（写文件） |
| 改一下现有代码 | edit（编辑文件） |
| 运行测试命令 | bash（执行命令） |
| 找到某个函数在哪 | grep/glob（搜索） |

---

## 工具全景图

```
┌─────────────────────────────────────────────────────────────────┐
│                      OpenCode 工具库                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    文件操作类                             │   │
│  │                                                          │   │
│  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐        │   │
│  │  │  read  │  │ write  │  │  edit  │  │ patch  │        │   │
│  │  │ 读文件  │  │ 写文件  │  │ 编辑   │  │ 打补丁  │        │   │
│  │  └────────┘  └────────┘  └────────┘  └────────┘        │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    搜索查找类                             │   │
│  │                                                          │   │
│  │  ┌────────┐  ┌────────┐  ┌────────┐                     │   │
│  │  │  grep  │  │  glob  │  │  list  │                     │   │
│  │  │内容搜索 │  │文件搜索 │  │列目录  │                     │   │
│  │  └────────┘  └────────┘  └────────┘                     │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    系统交互类                             │   │
│  │                                                          │   │
│  │  ┌────────┐  ┌────────┐                                 │   │
│  │  │  bash  │  │webfetch│                                 │   │
│  │  │执行命令 │  │访问网页 │                                 │   │
│  │  └────────┘  └────────┘                                 │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    任务管理类                             │   │
│  │                                                          │   │
│  │  ┌──────────┐  ┌──────────┐                             │   │
│  │  │ todowrite│  │ todoread │                             │   │
│  │  │ 写待办   │  │ 读待办   │                             │   │
│  │  └──────────┘  └──────────┘                             │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 内置工具详解

### read - 读取文件

**功能**：让 AI 看到文件内容

**使用场景**：
- 理解现有代码
- 分析文件结构
- 查看配置文件

**AI 调用示例**：
```
AI 内部调用：
read({ path: "src/auth/login.ts" })

返回：
文件的完整内容，带行号
```

**小白理解**：就像让 AI "打开"一个文件看看里面写了啥。

---

### write - 写入文件

**功能**：创建新文件或覆盖现有文件

**使用场景**：
- 创建新的代码文件
- 生成配置文件
- 保存输出结果

**AI 调用示例**：
```
AI 内部调用：
write({
  path: "src/utils/helper.ts",
  content: "export function helper() { ... }"
})
```

**小白理解**：就像让 AI 新建一个文件，然后往里写东西。

---

### edit - 编辑文件

**功能**：精确修改文件中的特定内容

**使用场景**：
- 修改函数实现
- 添加新代码
- 修复 Bug

**AI 调用示例**：
```
AI 内部调用：
edit({
  path: "src/auth/login.ts",
  old_string: "function login() {",
  new_string: "async function login() {"
})
```

**小白理解**：就像"查找替换"，找到旧代码，换成新代码。

---

### bash - 执行命令

**功能**：在终端执行 Shell 命令

**使用场景**：
- 运行测试 `npm test`
- 安装依赖 `npm install`
- Git 操作 `git status`
- 构建项目 `npm run build`

**AI 调用示例**：
```
AI 内部调用：
bash({ command: "npm test" })

返回：
命令的输出结果
```

**小白理解**：就像让 AI 帮你在终端敲命令。

---

### grep - 内容搜索

**功能**：在文件内容中搜索特定文本或正则表达式

**使用场景**：
- 查找函数定义
- 搜索变量使用
- 查找 TODO 注释

**AI 调用示例**：
```
AI 内部调用：
grep({
  pattern: "function authenticate",
  path: "src/"
})
```

**小白理解**：就像在所有文件里搜索某个关键词。

---

### glob - 文件搜索

**功能**：按文件名模式查找文件

**使用场景**：
- 找到所有 TypeScript 文件 `**/*.ts`
- 找到所有测试文件 `**/*.test.js`
- 找到某个目录下的文件

**AI 调用示例**：
```
AI 内部调用：
glob({ pattern: "src/**/*.ts" })

返回：
匹配的文件路径列表
```

**小白理解**：就像用通配符找文件，比如找所有 `.ts` 结尾的文件。

---

### list - 列出目录

**功能**：查看目录中有哪些文件和子目录

**AI 调用示例**：
```
AI 内部调用：
list({ path: "src/components" })

返回：
该目录下的文件和子目录列表
```

**小白理解**：就像在资源管理器里打开一个文件夹看看。

---

### patch - 打补丁

**功能**：应用 diff 格式的补丁到文件

**使用场景**：
- 应用代码修改
- 批量更新

**小白理解**：就像 Git 的 patch，一次性改多处。

---

### webfetch - 访问网页

**功能**：获取网页内容

**使用场景**：
- 查看在线文档
- 获取 API 说明
- 研究参考资料

**AI 调用示例**：
```
AI 内部调用：
webfetch({
  url: "https://docs.example.com/api",
  prompt: "获取认证相关的文档"
})
```

**小白理解**：让 AI 能上网查资料。

---

### todowrite / todoread - 任务管理

**功能**：管理待办事项列表

**使用场景**：
- 复杂任务的进度追踪
- 多步骤操作的记录

**小白理解**：AI 给自己记笔记，记住还有哪些事要做。

---

## 配置工具

### 全局配置

在 `opencode.json` 中控制所有 Agent 的工具：

```json
{
  "$schema": "https://opencode.ai/config.json",
  "tools": {
    "write": true,
    "edit": true,
    "bash": true,
    "read": true,
    "grep": true,
    "glob": true,
    "webfetch": true
  }
}
```

### 禁用某个工具

```json
{
  "tools": {
    "bash": false
  }
}
```

这样 AI 就不能执行任何命令了。

### 按 Agent 配置

```json
{
  "agent": {
    "plan": {
      "tools": {
        "write": false,
        "edit": false,
        "bash": false
      }
    }
  }
}
```

这样 Plan Agent 就只能读不能写了。

### 使用通配符

```json
{
  "tools": {
    "mcp_github_*": false
  }
}
```

禁用所有以 `mcp_github_` 开头的工具（通常是 MCP Server 提供的）。

---

## 工具对比表

| 工具 | 读 | 写 | 搜索 | 命令 | 网络 |
|------|----|----|------|------|------|
| read | ✅ | | | | |
| write | | ✅ | | | |
| edit | | ✅ | | | |
| patch | | ✅ | | | |
| grep | | | ✅ | | |
| glob | | | ✅ | | |
| list | ✅ | | | | |
| bash | | | | ✅ | |
| webfetch | | | | | ✅ |

---

## 工具权限

工具可以设置三种权限级别：

| 权限 | 含义 | 适用场景 |
|------|------|---------|
| `allow` | 自动执行，不需确认 | 信任的操作 |
| `ask` | 每次执行前询问用户 | 需要审核的操作 |
| `deny` | 完全禁用 | 危险操作 |

### 配置示例

```json
{
  "permission": {
    "edit": "ask",
    "bash": "ask",
    "webfetch": "allow"
  }
}
```

这样每次 AI 要改文件或执行命令，都会先问你。

---

## 扩展工具

除了内置工具，还可以通过以下方式扩展：

### 1. 自定义工具
在配置中定义自己的工具函数。

### 2. MCP Server
添加外部服务提供的工具，如：
- 数据库访问
- API 调用
- 第三方服务

详见 [MCP Server 详解](./05-mcp.md)

---

## 实用技巧

### 1. 安全起见，让危险操作需要确认

```json
{
  "permission": {
    "bash": {
      "rm *": "deny",
      "git push *": "ask",
      "*": "allow"
    }
  }
}
```

### 2. 只读模式分析代码

```json
{
  "agent": {
    "analyzer": {
      "description": "只读分析代理",
      "tools": {
        "write": false,
        "edit": false,
        "bash": false
      }
    }
  }
}
```

### 3. 让 AI 先查后改

```
# 先让 AI 用 grep 找到相关代码
Find all usages of the deprecated API

# 看完结果后再让它改
Now update all those usages to use the new API
```

---

## 常见问题

### Q: 为什么 AI 说它不能执行某个操作？
**A:** 可能是对应的工具被禁用了。检查 `opencode.json` 中的 `tools` 配置。

### Q: 如何让 AI 执行命令前先确认？
**A:** 设置权限为 `ask`：
```json
{
  "permission": {
    "bash": "ask"
  }
}
```

### Q: 工具太多影响 AI 性能吗？
**A:** 有一点影响。如果你开启了很多 MCP Server，会增加 AI 的 context 大小。建议只开启需要的工具。

### Q: 工具底层用什么实现的？
**A:** 搜索类工具（grep、glob、list）底层用的是 [ripgrep](https://github.com/BurntSushi/ripgrep)，非常快。

---

## 下一步

- 了解如何配置 [Provider（提供商）](./03-provider.md)
- 学习 [Permission（权限）](./08-permission.md) 精细控制
- 探索 [MCP Server](./05-mcp.md) 扩展更多工具
