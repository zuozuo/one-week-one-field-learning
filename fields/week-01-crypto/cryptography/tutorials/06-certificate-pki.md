# 数字证书与PKI（Certificate & Public Key Infrastructure）

## 一句话大白话

**数字证书就是网络世界的"身份证"，由权威机构（CA）签发，证明"这个公钥确实属于这个网站/人"。**

```
现实世界：
身份证 = 政府盖章 + 你的信息 + 你的照片
         ↓
      证明你是你

数字世界：
证书 = CA签名 + 网站信息 + 网站公钥
         ↓
      证明公钥属于该网站
```

## 它解决什么问题

数字证书解决的是**公钥信任**问题：

```
困境：
- Bob声称公钥X是他的
- 但你怎么知道这真的是Bob的公钥？
- 中间人可以把自己的公钥冒充Bob的！

解决方案：
- 找一个你信任的第三方（CA）
- CA验证Bob身份后，给Bob的公钥"盖章"
- 你信任CA → CA信任Bob → 你信任Bob
```

**没有证书的世界：**
```
你访问 taobao.com
      │
      ▼
收到一个公钥，声称是淘宝的
      │
      ▼
但你无法验证！
      │
      ▼
可能是钓鱼网站的公钥
      │
      ▼
你的密码、银行卡信息全被偷了 😱
```

**有证书的世界：**
```
你访问 taobao.com
      │
      ▼
收到数字证书
      │
      ▼
验证CA签名 ✓
      │
      ▼
确认公钥确实属于 taobao.com ✓
      │
      ▼
安全通信 🔐
```

## 证书的内容

```
┌─────────────────────────────────────────────────────────────────┐
│                    X.509 数字证书结构                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 版本号: v3                                               │   │
│  │ 序列号: 123456789                                        │   │
│  │ 签名算法: SHA256-RSA                                     │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ 颁发者(Issuer): DigiCert CA                             │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ 有效期:                                                  │   │
│  │   开始: 2024-01-01 00:00:00                             │   │
│  │   结束: 2025-01-01 00:00:00                             │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ 主体(Subject): CN=www.taobao.com, O=Alibaba, C=CN       │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ 主体公钥:                                                │   │
│  │   算法: RSA                                              │   │
│  │   公钥: 30820122300d06092a864886f70d01010105...         │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ 扩展信息:                                                │   │
│  │   - 使用方式: 数字签名、密钥加密                         │   │
│  │   - 备用名称: *.taobao.com, taobao.com                  │   │
│  │   - CRL分发点: http://crl.digicert.com/...              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ CA的数字签名（对上述所有内容的签名）                      │   │
│  │ 签名值: 3046022100c5a3...                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## PKI：公钥基础设施

PKI是一套完整的信任体系：

```
┌─────────────────────────────────────────────────────────────────┐
│                         PKI 组成                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐                                               │
│  │   根CA      │  ← 最顶层，被操作系统/浏览器信任               │
│  │ (Root CA)   │     如：DigiCert, Let's Encrypt              │
│  └──────┬──────┘                                               │
│         │ 签发                                                  │
│         ▼                                                       │
│  ┌─────────────┐                                               │
│  │   中间CA    │  ← 二级机构，由根CA签发                        │
│  │(Intermediate│     分担根CA工作，安全隔离                     │
│  └──────┬──────┘                                               │
│         │ 签发                                                  │
│         ▼                                                       │
│  ┌─────────────┐                                               │
│  │  终端证书   │  ← 最终用户的证书                              │
│  │(End Entity) │     如：taobao.com 的证书                      │
│  └─────────────┘                                               │
│                                                                 │
│  其他组件：                                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │     RA      │  │    CRL      │  │    OCSP     │            │
│  │ 注册机构    │  │ 吊销列表    │  │ 在线状态    │            │
│  │ 验证申请者  │  │ 失效证书表  │  │ 实时查询    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 证书链（信任链）

```
┌─────────────────────────────────────────────────────────────────┐
│                      证书链验证流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  浏览器/操作系统内置信任的根CA                                   │
│                ↑                                                │
│                │ 验证签名                                       │
│                │                                                │
│  ┌─────────────────────────────────────────┐                   │
│  │        根CA证书 (Root)                   │                   │
│  │  自签名：自己给自己签名                   │                   │
│  │  预装在浏览器/操作系统中                  │                   │
│  └────────────────────┬────────────────────┘                   │
│                       │                                         │
│                       ▼ 验证签名                                │
│  ┌─────────────────────────────────────────┐                   │
│  │      中间CA证书 (Intermediate)           │                   │
│  │  由根CA签发                              │                   │
│  │  用于签发终端证书                        │                   │
│  └────────────────────┬────────────────────┘                   │
│                       │                                         │
│                       ▼ 验证签名                                │
│  ┌─────────────────────────────────────────┐                   │
│  │       服务器证书 (End Entity)            │                   │
│  │  由中间CA签发                            │                   │
│  │  包含服务器公钥                          │                   │
│  └─────────────────────────────────────────┘                   │
│                                                                 │
│  验证流程（从下往上）：                                          │
│  1. 检查服务器证书有效期                                        │
│  2. 用中间CA公钥验证服务器证书签名                              │
│  3. 用根CA公钥验证中间CA证书签名                                │
│  4. 检查根CA是否在信任列表中                                     │
│  5. 全部通过 → 证书可信 ✅                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 什么时候用 / 什么时候别用

### ✅ 适合用的场景

| 场景 | 说明 |
|------|------|
| HTTPS网站 | 向用户证明网站身份 |
| 代码签名 | 证明软件来自可信发布者 |
| 电子邮件(S/MIME) | 加密邮件、证明发件人 |
| 客户端认证 | 用证书代替密码登录 |
| 企业VPN | 验证员工身份 |

### ❌ 不适合用的场景

| 场景 | 原因 |
|------|------|
| 内部测试环境 | 可用自签名证书，省钱 |
| 私有通信 | 可用预共享公钥，不需要CA |
| 匿名通信 | 证书会暴露身份 |

## 它不是什么（常见混淆）

| 误解 | 真相 |
|------|------|
| "证书能加密数据" | ❌ 证书只是公钥的容器，加密用公钥 |
| "有证书就绝对安全" | ❌ 证书只验证身份，不能防钓鱼网站 |
| "自签名证书不安全" | ⚠️ 自签名证书本身安全，只是不被浏览器信任 |
| "证书过期后不能用" | ⚠️ 技术上能用，但验证会失败，不应该用 |

## 证书类型

```
┌─────────────────────────────────────────────────────────────────┐
│                      SSL证书类型                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  按验证级别：                                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ DV (Domain Validation)                                   │   │
│  │ - 只验证域名所有权                                       │   │
│  │ - 几分钟签发                                             │   │
│  │ - 便宜/免费 (Let's Encrypt)                             │   │
│  │ - 适合：个人网站、博客                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ OV (Organization Validation)                             │   │
│  │ - 验证域名+组织身份                                      │   │
│  │ - 需要提交企业资料                                       │   │
│  │ - 1-3天签发                                              │   │
│  │ - 适合：企业官网                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ EV (Extended Validation)                                 │   │
│  │ - 最严格验证                                             │   │
│  │ - 验证法律实体、经营状态                                 │   │
│  │ - 地址栏显示公司名（部分浏览器）                         │   │
│  │ - 适合：银行、金融机构                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  按覆盖范围：                                                    │
│  - 单域名：只保护 www.example.com                              │
│  - 多域名(SAN)：保护多个不同域名                               │
│  - 通配符(Wildcard)：保护 *.example.com                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 最小例子

### 查看网站证书（命令行）

```bash
# 查看网站证书
openssl s_client -connect www.taobao.com:443 -showcerts

# 查看证书详细信息
echo | openssl s_client -connect www.taobao.com:443 2>/dev/null | \
  openssl x509 -text -noout

# 关键信息
echo | openssl s_client -connect www.taobao.com:443 2>/dev/null | \
  openssl x509 -noout -subject -issuer -dates
```

### 生成自签名证书

```bash
# 生成私钥
openssl genrsa -out server.key 2048

# 生成证书签名请求(CSR)
openssl req -new -key server.key -out server.csr \
  -subj "/CN=localhost/O=My Company/C=CN"

# 自签名（有效期365天）
openssl x509 -req -days 365 -in server.csr \
  -signkey server.key -out server.crt

# 查看证书
openssl x509 -in server.crt -text -noout
```

### Python 验证证书

```python
import ssl
import socket

def verify_certificate(hostname, port=443):
    context = ssl.create_default_context()

    with socket.create_connection((hostname, port)) as sock:
        with context.wrap_socket(sock, server_hostname=hostname) as ssock:
            cert = ssock.getpeercert()

            print(f"主体: {cert['subject']}")
            print(f"颁发者: {cert['issuer']}")
            print(f"有效期: {cert['notBefore']} - {cert['notAfter']}")
            print(f"备用名称: {cert.get('subjectAltName', [])}")

            return True

# 验证淘宝的证书
try:
    verify_certificate("www.taobao.com")
    print("证书验证成功 ✅")
except ssl.SSLCertVerificationError as e:
    print(f"证书验证失败 ❌: {e}")
```

### 使用 Let's Encrypt 获取免费证书

```bash
# 安装 certbot
sudo apt install certbot

# 获取证书（需要验证域名所有权）
sudo certbot certonly --standalone -d yourdomain.com

# 证书位置
ls /etc/letsencrypt/live/yourdomain.com/
# cert.pem      - 证书
# privkey.pem   - 私钥
# chain.pem     - 证书链
# fullchain.pem - 完整证书链

# 自动续期
sudo certbot renew --dry-run
```

## 新手最常踩的 3 个坑

### 坑1：证书链不完整

```
❌ 错误配置（Nginx）
ssl_certificate server.crt;  # 只有服务器证书

✅ 正确配置
ssl_certificate fullchain.crt;  # 包含中间证书！

# fullchain.crt 内容：
# -----BEGIN CERTIFICATE-----
# (服务器证书)
# -----END CERTIFICATE-----
# -----BEGIN CERTIFICATE-----
# (中间CA证书)
# -----END CERTIFICATE-----
```

**为什么是坑：**
- 浏览器可能没有中间CA证书
- 导致验证失败，显示"证书不受信任"
- 部分旧设备/浏览器特别容易出问题

### 坑2：使用过期证书

```
❌ 忽略警告继续使用
# 证书2023年就过期了，但懒得换...

✅ 正确做法
# 1. 设置监控告警
# 2. 提前30天续期
# 3. 使用自动续期（Let's Encrypt + certbot）

# 检查过期时间
openssl x509 -enddate -noout -in server.crt
```

**为什么是坑：**
- 浏览器会显示警告页面，用户吓跑
- SEO排名下降
- 可能被中间人攻击（用户习惯忽略警告）

### 坑3：私钥泄露后不吊销证书

```
❌ 危险做法
# 发现私钥被黑客窃取
# 但觉得重新申请证书太麻烦，先凑合用着...

✅ 正确做法
# 1. 立即吊销旧证书
# 2. 生成新的密钥对
# 3. 申请新证书
# 4. 更新服务器配置
# 5. 通知用户（如果影响大）
```

**为什么是坑：** 攻击者可以用泄露的私钥冒充你的网站，进行中间人攻击，窃取用户数据。

## 证书吊销

```
┌─────────────────────────────────────────────────────────────────┐
│                    证书吊销机制                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  为什么要吊销？                                                  │
│  - 私钥泄露                                                     │
│  - 证书信息变更                                                 │
│  - CA发错证书                                                   │
│  - 公司不再运营                                                 │
│                                                                 │
│  两种吊销检查方式：                                              │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ CRL (Certificate Revocation List)                        │   │
│  │ - CA定期发布被吊销证书列表                                │   │
│  │ - 客户端下载整个列表                                      │   │
│  │ - 缺点：列表可能很大，更新不及时                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ OCSP (Online Certificate Status Protocol)               │   │
│  │ - 实时查询单个证书状态                                   │   │
│  │ - 响应更快，更省带宽                                     │   │
│  │ - OCSP Stapling: 服务器缓存OCSP响应                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 流程图定位

```
┌─────────────────────────────────────────────────────────────────┐
│                     安全通信流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ████████████ → 密钥交换 → 对称加密通信                         │
│  │ 身份验证 │  ← 你在这里！                                     │
│  ████████████                                                   │
│       │                                                         │
│       ├── 服务器发送证书                                        │
│       │      │                                                  │
│       │      ▼                                                  │
│       ├── 验证证书链                                            │
│       │      │                                                  │
│       │      ▼                                                  │
│       ├── 检查证书有效期                                        │
│       │      │                                                  │
│       │      ▼                                                  │
│       ├── 检查是否被吊销                                        │
│       │      │                                                  │
│       │      ▼                                                  │
│       └── 提取公钥，用于密钥交换                                │
│                                                                 │
│  证书解决了"公钥属于谁"的问题                                    │
│  有了证书，密钥交换才不怕中间人攻击                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**上游依赖：** 数字签名（CA签名证书）、哈希函数（证书指纹）
**下游消费：** 密钥交换（提供可信公钥）

## 自测题

### 题目1：为什么浏览器信任根CA的证书？

<details>
<summary>点击查看答案</summary>

因为根CA证书是预装在浏览器/操作系统中的。

信任链：
1. 操作系统厂商（Apple/Microsoft/Google）审核CA
2. 审核通过的CA被加入"根证书存储"
3. 浏览器使用系统的根证书存储
4. 用户安装系统时就自带这些信任

这是一种"传递信任"模式：
- 你信任Apple → Apple信任DigiCert → DigiCert信任taobao.com
- 所以你信任taobao.com

这也是为什么根CA被入侵是灾难性的——所有人的信任链都会断裂。

</details>

### 题目2：自签名证书和CA签发的证书有什么区别？

<details>
<summary>点击查看答案</summary>

**技术上：**
- 自签名：自己的私钥签自己的公钥
- CA签发：CA的私钥签你的公钥

**信任上：**
- 自签名：只有你自己信任，浏览器显示警告
- CA签发：全世界的浏览器都信任

**安全性：**
- 两者加密强度相同
- 但自签名无法防止中间人攻击（因为攻击者也能自签名）

**适用场景：**
- 自签名：开发测试、内部系统
- CA签发：面向公众的服务

</details>

### 题目3：为什么需要中间CA，不直接用根CA签发所有证书？

<details>
<summary>点击查看答案</summary>

三个原因：

1. **安全隔离**：
   - 根CA私钥极其重要，应该离线保存
   - 如果根CA频繁签发证书，暴露风险大
   - 中间CA被入侵，只需吊销它，不影响根CA

2. **灵活管理**：
   - 不同中间CA可以签发不同类型证书
   - 可以按区域/业务划分中间CA
   - 方便吊销和更新

3. **扩展性**：
   - 根CA有限，中间CA可以很多
   - 分散签发工作负载

比喻：
- 根CA = 国家最高法院
- 中间CA = 地方法院
- 最高法院不可能审理每个案件，授权地方法院处理

</details>

---

## 总结

| 要点 | 内容 |
|------|------|
| 核心概念 | 证书=公钥+身份+CA签名，证明公钥归属 |
| 信任机制 | 证书链：根CA→中间CA→终端证书 |
| 验证流程 | 检查签名链+有效期+吊销状态 |
| 关键注意 | 证书链要完整，私钥泄露要吊销 |

**下一步：** 学习[HTTPS握手实战案例](case-study.md)，把所有知识串联起来！
