# Gas 机制

## 一句话大白话

**Gas 就是以太坊的「燃料费」——你想让网络帮你做事，就得付费。事情越复杂，费越贵。**

就像寄快递：东西越重、距离越远、越想快送到，费用就越高。Gas 就是以太坊的「快递费」。

---

## 它解决什么问题

### 核心问题：如何防止网络被滥用？

如果执行交易不需要付费，会发生什么？
- 攻击者可以无限发送垃圾交易，堵塞网络
- 可以写死循环合约，让所有节点都卡死
- 网络很快就会瘫痪

**Gas 的解决方案**：
- 每个操作都有价格
- 操作越多、越复杂，费用越高
- 先付费后执行，执行失败也要扣费
- 经济手段遏制恶意行为

### 三个关键作用

1. **计量资源消耗**：每个操作消耗多少计算资源
2. **防止滥用**：让攻击变得昂贵
3. **激励机制**：奖励验证者（原来是矿工）处理交易

---

## 什么时候用 / 什么时候别用

### Gas 相关场景

| 场景 | Gas 消耗 | 说明 |
|------|---------|------|
| 普通转账 | 21,000 Gas（固定） | 最简单的操作 |
| 调用合约 | 变化（可能数十万） | 取决于合约逻辑复杂度 |
| 部署合约 | 很高（可能数百万） | 存储代码很贵 |
| 存储数据 | 很贵 | SSTORE 是最贵的操作之一 |
| 读取数据 | 相对便宜 | 只读不改便宜 |

### 什么时候需要关注 Gas

| 情况 | 关注程度 | 原因 |
|------|---------|------|
| 网络拥堵时 | 高 | Gas Price 可能暴涨10倍以上 |
| 大额交易 | 中 | Gas 费占比小，安全更重要 |
| 频繁小额操作 | 高 | Gas 费可能超过交易金额 |
| 智能合约开发 | 非常高 | 设计影响用户使用成本 |

---

## 它不是什么

### 常见误解

| 误解 | 真相 |
|------|------|
| 「Gas = ETH」 | Gas 是单位，Gas Price（用 ETH 计价）才决定花多少钱 |
| 「设置高 Gas 就不会失败」 | Gas Limit 高只是保证够用，合约本身出错还是会失败 |
| 「交易失败 Gas 会退回」 | 失败也要扣 Gas，因为网络已经消耗了计算资源 |
| 「Gas 费给了以太坊公司」 | Gas 费给验证者/矿工，以太坊没有公司 |
| 「Gas 费是固定的」 | Gas 费随网络拥堵程度波动，差异可达数十倍 |

---

## 最小例子

### Gas 计费公式

```
交易费用 = Gas Used × Gas Price

具体到 EIP-1559 后的公式：
交易费用 = Gas Used × (Base Fee + Priority Fee)

其中：
- Gas Used：实际消耗的 Gas 单位
- Base Fee：由网络决定的基础费（会被销毁）
- Priority Fee（小费）：给验证者的激励
```

### 真实的 Gas 计算示例

```
场景：普通 ETH 转账

Gas Limit: 21,000 (设置的上限)
Gas Used: 21,000 (实际使用)
Base Fee: 30 Gwei
Priority Fee: 2 Gwei

计算：
交易费用 = 21,000 × (30 + 2) Gwei
        = 21,000 × 32 Gwei
        = 672,000 Gwei
        = 0.000672 ETH

如果 ETH = $2000：
费用 = 0.000672 × $2000 = $1.34
```

### 单位换算

```
1 ETH = 1,000,000,000 Gwei (10^9)
1 ETH = 1,000,000,000,000,000,000 Wei (10^18)

常用单位：
Wei = 最小单位
Gwei = 10^9 Wei (Gas Price 常用单位)
ETH = 10^18 Wei

记忆口诀：
- Gwei 的 G = Giga = 十亿
- 所以 1 Gwei = 十亿 Wei
```

### 常见操作的 Gas 消耗

```
操作                          Gas 消耗      说明
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
基础交易费                     21,000       任何交易的最低消耗
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
SSTORE (存储新值)              22,100       往合约存储写新数据
SSTORE (修改现有值)            5,000        修改已有的存储槽
SSTORE (清零/删除)             退还部分      删除数据会退还一些 Gas
SLOAD (读取存储)               2,100        从合约存储读数据
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
合约创建                       32,000       部署合约的基础费
+ 每字节代码                   200          存储合约代码
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
CALL (调用合约)                基础 100+    调用外部合约
LOG (触发事件)                 375+         记录事件日志
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

真实例子：
- 简单 ETH 转账：约 21,000 Gas ≈ $1-5
- ERC-20 代币转账：约 65,000 Gas ≈ $3-15
- Uniswap 交换：约 150,000 Gas ≈ $7-35
- 部署简单合约：约 500,000 Gas ≈ $25-100
- 部署复杂合约：可能数百万 Gas ≈ $100-500+

（价格会随网络拥堵程度大幅波动）
```

### EIP-1559 机制详解

```
EIP-1559 之前（传统模式）：
┌─────────────────────────────────────────┐
│  用户设置: Gas Price                     │
│  所有费用 → 矿工                         │
│  问题: 难以预估，容易多付                 │
└─────────────────────────────────────────┘

EIP-1559 之后（2021年8月后）：
┌─────────────────────────────────────────┐
│  Base Fee (基础费)                       │
│  ├─ 由网络自动计算                       │
│  ├─ 根据上一区块使用率调整                │
│  └─ 完全销毁（不给任何人）                │
│                                          │
│  Priority Fee (小费/优先费)               │
│  ├─ 用户自行设置                         │
│  └─ 给验证者                             │
│                                          │
│  Max Fee (最高费)                        │
│  ├─ 用户愿意支付的最高价格                │
│  └─ 超出部分会退还                       │
└─────────────────────────────────────────┘

Base Fee 的调整逻辑：
┌─────────────────────────────────────────┐
│  区块使用率 50% → Base Fee 不变          │
│  区块使用率 100% → Base Fee 最多涨12.5%  │
│  区块使用率 0% → Base Fee 最多跌12.5%    │
└─────────────────────────────────────────┘

好处：
1. 更可预测的费用
2. 多付的会退还
3. ETH 会被销毁（通缩压力）
```

### JavaScript 示例

```javascript
const { ethers } = require('ethers');

// 连接以太坊节点
const provider = new ethers.JsonRpcProvider('https://mainnet.infura.io/v3/YOUR-KEY');

// 获取当前 Gas 价格信息
async function getGasInfo() {
    // 获取当前区块的 base fee
    const block = await provider.getBlock('latest');
    console.log('Base Fee:', ethers.formatUnits(block.baseFeePerGas, 'gwei'), 'Gwei');

    // 获取建议的费用
    const feeData = await provider.getFeeData();
    console.log('建议 Max Fee:', ethers.formatUnits(feeData.maxFeePerGas, 'gwei'), 'Gwei');
    console.log('建议 Priority Fee:', ethers.formatUnits(feeData.maxPriorityFeePerGas, 'gwei'), 'Gwei');
}

// 估算交易的 Gas
async function estimateGas() {
    const tx = {
        to: '0x742d35Cc6634C0532925a3b844Bc454e4438f44e',
        value: ethers.parseEther('0.1'),  // 转 0.1 ETH
    };

    const gasLimit = await provider.estimateGas(tx);
    console.log('预估 Gas Limit:', gasLimit.toString());

    // 计算费用
    const feeData = await provider.getFeeData();
    const maxCost = gasLimit * feeData.maxFeePerGas;
    console.log('最大费用:', ethers.formatEther(maxCost), 'ETH');
}

// 发送交易时设置 Gas
async function sendTransaction(wallet) {
    const tx = await wallet.sendTransaction({
        to: '0x742d35Cc6634C0532925a3b844Bc454e4438f44e',
        value: ethers.parseEther('0.1'),
        // EIP-1559 参数
        maxFeePerGas: ethers.parseUnits('50', 'gwei'),      // 最高愿付
        maxPriorityFeePerGas: ethers.parseUnits('2', 'gwei'), // 小费
        gasLimit: 21000,
    });

    console.log('交易哈希:', tx.hash);

    const receipt = await tx.wait();
    console.log('实际消耗 Gas:', receipt.gasUsed.toString());
    console.log('实际费用:', ethers.formatEther(receipt.gasUsed * receipt.gasPrice), 'ETH');
}
```

---

## 新手最常踩的 3 个坑

### 坑 1：Gas Limit 设太低导致交易失败

**场景**：
```
你设置 Gas Limit: 50,000
合约实际需要: 80,000

结果：
- 交易在执行到一半时 Gas 耗尽
- 所有状态改变被回滚
- 但已消耗的 50,000 Gas 不退！
- 钱花了，事没办成
```

**正确做法**：
```javascript
// 方法1：使用钱包默认估算（推荐）
// 大多数钱包会自动估算并加 20-50% 余量

// 方法2：手动估算
const estimated = await provider.estimateGas(tx);
const safeLimit = estimated * 120n / 100n; // 加 20% 余量

// 方法3：对于已知操作使用固定值
// - 普通转账：21,000（固定不变）
// - ERC-20 转账：约 65,000
// - Uniswap：约 200,000
```

### 坑 2：在高峰期发交易，Gas 费暴涨

**场景**：
```
某热门 NFT 发售：
平时 Base Fee: 20 Gwei
发售时 Base Fee: 500 Gwei（25倍！）

一笔普通交易费用：
平时：21,000 × 20 Gwei = 0.00042 ETH ≈ $0.84
高峰：21,000 × 500 Gwei = 0.0105 ETH ≈ $21
```

**正确做法**：
```
1. 非紧急交易等网络空闲时发（通常是周末或美国凌晨）
2. 使用 Gas 追踪器监控价格：
   - https://etherscan.io/gastracker
   - https://www.blocknative.com/gas-estimator
3. 设置合理的 Max Fee，避免被「抢跑」
4. 对于 DeFi 操作，设置滑点保护
```

### 坑 3：不理解 Gas Limit vs Gas Price

**混淆**：
```
Gas Limit（数量上限）：
- 你愿意最多消耗多少「单位」的 Gas
- 设太低会失败，设太高不影响（多余的会退）
- 由操作的复杂度决定

Gas Price（单价）：
- 每单位 Gas 愿意付多少 ETH
- 设太低可能长时间不被处理
- 由网络拥堵程度决定

类比快递：
- Gas Limit = 包裹重量上限
- Gas Price = 每公斤价格
- 总费用 = 实际重量 × 单价
```

**图解**：
```
┌─────────────────────────────────────────────────────────┐
│  你设置的                                               │
│  Gas Limit: 100,000                                     │
│  Max Fee: 50 Gwei                                       │
│  最大预算: 100,000 × 50 = 5,000,000 Gwei = 0.005 ETH    │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  实际执行                                               │
│  Gas Used: 65,000 (实际消耗)                            │
│  Effective Price: 32 Gwei (Base 30 + Priority 2)        │
│  实际费用: 65,000 × 32 = 2,080,000 Gwei = 0.00208 ETH   │
│                                                         │
│  退还: 0.005 - 0.00208 = 0.00292 ETH                    │
└─────────────────────────────────────────────────────────┘
```

---

## 流程图定位

```
┌─────────────────────────────────────────────────────────────────────┐
│                    以太坊交易生命周期                                │
└─────────────────────────────────────────────────────────────────────┘

┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  创建    │    │  签名    │    │  广播    │    │  确认    │
│  钱包    │ -> │  交易    │ -> │  交易    │ -> │  等待    │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
                     │               │               │
                     v               v               v
              ┌──────────────────────────────────────────┐
              │  [你在这里学习的内容]                     │
              │                                          │
              │  Gas 参与交易的每个环节：                  │
              │  ├─ 签名时：设置 Gas Limit 和 Gas Price   │
              │  ├─ 广播后：验证者按 Gas Price 排序       │
              │  └─ 执行时：每个操作消耗 Gas              │
              │                                          │
              │  交易费用 = Gas Used × Gas Price          │
              │  费用去向：Base Fee 销毁，Priority 给验证者│
              └──────────────────────────────────────────┘
```

---

## 自测题

### 基础理解

1. **Gas Limit 和 Gas Price 的区别是什么？哪个设太低会导致交易失败，哪个设太低会导致交易处理很慢？**

<details>
<summary>参考答案</summary>

- **Gas Limit**：交易允许消耗的最大 Gas 单位数
  - 设太低：交易中途 Gas 耗尽，失败并回滚，但已消耗的 Gas 不退
  - 设太高：没问题，多余的会退还

- **Gas Price**：每单位 Gas 愿意支付的价格
  - 设太低：交易可能长时间待在 mempool 不被处理
  - 设太高：交易处理快，但花费更多 ETH

总结：
- Gas Limit 太低 → 交易失败
- Gas Price 太低 → 交易慢（可能卡住）
</details>

2. **EIP-1559 改进了什么？Base Fee 和 Priority Fee 分别是什么，去向哪里？**

<details>
<summary>参考答案</summary>

EIP-1559 改进：
1. 费用更可预测（Base Fee 自动调整）
2. 减少多付（多余的会退还）
3. 引入 ETH 销毁机制

两种费用：
- **Base Fee**：
  - 由协议根据网络拥堵自动计算
  - 完全销毁（不给任何人）
  - 每个区块最多变化 12.5%

- **Priority Fee（小费）**：
  - 用户自己设置
  - 给验证者，作为处理交易的激励
  - 越高越可能优先处理
</details>

3. **为什么交易失败也要扣 Gas 费？这公平吗？**

<details>
<summary>参考答案</summary>

为什么要扣：
- 验证者已经消耗了计算资源来执行你的交易
- 如果失败不扣费，攻击者可以无成本发送大量注定失败的复杂交易来攻击网络
- 这是防止拒绝服务攻击的重要机制

是否公平：
- 从网络角度：公平，资源已消耗
- 从用户角度：可能感觉不公平，但这是必要的安全机制

建议：
- 发交易前充分测试
- 使用 `estimateGas` 预估
- 理解合约逻辑，避免因条件不满足而失败
</details>

### 进阶思考

4. **作为智能合约开发者，你会如何优化合约以减少用户的 Gas 消耗？**

<details>
<summary>参考答案</summary>

Gas 优化策略：

1. **存储优化**（最重要）
   - 减少 SSTORE 操作（每次写存储约 20,000 Gas）
   - 使用事件(Events)代替存储来记录历史
   - 打包小变量（uint8, bool 等）到同一个存储槽

2. **循环优化**
   - 避免无界循环
   - 将循环中的存储读取移到循环外

3. **数据类型**
   - 使用 calldata 而非 memory（对外部函数的数组参数）
   - 固定大小优于动态大小

4. **模式优化**
   - 批量操作代替多次单独操作
   - 懒惰计算（只在需要时计算）

5. **代码层面**
   - 删除无用代码
   - 使用 error 代替 require 字符串（省存储）
   - 短路求值优化条件判断顺序
</details>
