# 共识算法概述

## 一句话大白话

**共识算法就是让一群互不信任的人对"谁说的对"达成一致的规则**——就像班级投票选班长，需要一套公平的规则让大家都服气。

---

## 它解决什么问题

### 核心困境：谁来记账？

想象一下没有银行的世界：

```
Alice 说："我给 Bob 转了 100 块"
Bob 说："我收到了"
Eve 说："不对！Alice 根本没钱！"

问题来了：
- 谁说的是真的？
- 谁有权记录这笔交易？
- 怎么防止有人篡改记录？
```

### 中心化 vs 去中心化

```
中心化方案：                    去中心化方案：

      银行                         所有人
       │                            │
       ▼                            ▼
┌─────────────┐              ┌─────────────┐
│  银行说了算 │              │  共识算法   │
│  信任银行  │              │  大家一起定 │
└─────────────┘              └─────────────┘
       │                            │
       ▼                            ▼
   单点故障                      无单点故障
   可能作恶                      规则透明
   审查交易                      抗审查
```

### 共识算法要解决的核心问题

| 问题 | 说明 |
|------|------|
| 一致性 | 所有诚实节点看到相同的数据 |
| 活性 | 系统能持续处理新交易 |
| 容错性 | 部分节点故障或作恶时仍能工作 |
| 去中心化 | 不依赖单一权威 |

---

## 什么时候用 / 什么时候别用

### ✅ 需要共识算法的场景

| 场景 | 原因 |
|------|------|
| 公链 | 开放加入，需要抵抗女巫攻击 |
| 联盟链 | 多方参与，需要拜占庭容错 |
| 分布式数据库 | 多副本一致性 |
| 去中心化投票 | 防止刷票和篡改 |

### ❌ 不需要共识算法的场景

| 场景 | 原因 |
|------|------|
| 单机应用 | 没有多方，无需共识 |
| 完全可信环境 | 信任已建立，用简单方案即可 |
| 低价值场景 | 共识成本高于保护的价值 |

---

## 它不是什么（常见混淆点）

### ❌ 共识 ≠ 投票

```
普通投票：
- 51% 赞成就通过
- 简单多数决

共识算法：
- 可能需要 2/3 以上同意（PBFT）
- 可能需要证明工作量（PoW）
- 可能需要质押资产（PoS）
- 复杂得多！
```

### ❌ 共识 ≠ 加密

```
加密：保护数据不被看到
共识：确保大家看到相同的数据

它们是不同的问题！
区块链同时使用两者，但不要混淆。
```

### ❌ 共识 ≠ 广播

```
广播：把消息发给所有人
共识：确保所有人对消息达成一致

广播可能丢包、延迟、被篡改
共识要处理这些问题
```

---

## 最小例子

### 共识算法的分类

```
┌────────────────────────────────────────────────────────────────┐
│                        共识算法分类                             │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌─────────────────────┐      ┌─────────────────────┐         │
│  │   概率性终局        │      │   确定性终局         │         │
│  │   (中本聪共识)      │      │   (经典共识)         │         │
│  └──────────┬──────────┘      └──────────┬──────────┘         │
│             │                            │                     │
│     ┌───────┴───────┐            ┌───────┴───────┐            │
│     │               │            │               │            │
│   PoW             PoS          PBFT           Raft            │
│  (比特币)      (以太坊2.0)    (联盟链)       (私有链)         │
│                                                                │
│  特点：                        特点：                          │
│  - 最终一致                    - 即时终局                      │
│  - 可能分叉                    - 不会分叉                      │
│  - 高容错                      - 节点数有限                    │
│  - 性能较低                    - 性能较高                      │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 常见共识算法对比

| 算法 | 代表项目 | 容错能力 | 性能(TPS) | 终局性 | 去中心化程度 |
|------|----------|----------|-----------|--------|-------------|
| PoW | Bitcoin | 50% 算力 | ~7 | 概率性 | 高 |
| PoS | Ethereum 2.0 | 33% 质押 | ~15-30 | 概率→确定 | 中高 |
| DPoS | EOS | 33% 代表 | ~1000+ | 确定性 | 中 |
| PBFT | Hyperledger | 33% 节点 | ~1000+ | 确定性 | 低 |
| Raft | etcd | 50% 节点 | ~10000+ | 确定性 | 低（非拜占庭）|

### 共识过程的通用模型

```
         提议                  投票/验证              确认
           │                      │                    │
           ▼                      ▼                    ▼
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│  1. 选择提议者   ──▶  2. 提议区块   ──▶  3. 验证区块        │
│     (谁有权)           (打包交易)          (检查合法)        │
│                                                              │
│                           │                                  │
│                           ▼                                  │
│                                                              │
│  4. 达成共识   ◀──  5. 广播结果   ◀──  6. 投票/证明         │
│     (写入链)          (通知全网)          (表态同意)         │
│                                                              │
└──────────────────────────────────────────────────────────────┘

不同算法的主要区别在于：
- 步骤 1：如何选择提议者（算力/质押/轮流/随机）
- 步骤 6：如何投票（消耗资源/签名/权重）
```

### 三种主流共识的直观对比

```
PoW（工作量证明）：
┌─────────────────────────────────────┐
│  谁算得快谁说了算                    │
│                                     │
│  节点A: "我算了 10 分钟！" ❌        │
│  节点B: "我算了 5 分钟！"  ✅ 胜出   │
│  节点C: "我算了 8 分钟！"  ❌        │
│                                     │
│  代价：电费、算力硬件               │
└─────────────────────────────────────┘

PoS（权益证明）：
┌─────────────────────────────────────┐
│  谁押的钱多谁有权说话                │
│                                     │
│  节点A: "我押了 100 ETH" ➜ 低概率   │
│  节点B: "我押了 10000 ETH" ➜ 高概率 │
│  节点C: "我押了 500 ETH" ➜ 中概率   │
│                                     │
│  代价：锁定资金、作恶罚没           │
└─────────────────────────────────────┘

PBFT（拜占庭容错）：
┌─────────────────────────────────────┐
│  投票决定，2/3 以上同意才算数        │
│                                     │
│  节点A: "同意" ✓                    │
│  节点B: "同意" ✓                    │
│  节点C: "反对" ✗                    │
│  节点D: "同意" ✓                    │
│                                     │
│  3/4 = 75% > 66.7%，共识达成！      │
└─────────────────────────────────────┘
```

---

## 新手最常踩的 3 个坑

### 坑 1：以为 PoW 是唯一的共识算法

**错误想法**："区块链 = 挖矿 = PoW"

**现实**：
- PoW 只是共识算法的一种
- 很多链用 PoS、DPoS、PBFT 等
- 以太坊已经从 PoW 转到 PoS

**教训**：不同场景适合不同的共识算法。

### 坑 2：混淆"最终性"的概念

**错误想法**："6 个确认后就绝对安全了"

**现实**：
- PoW/PoS 的最终性是**概率性**的
- 理论上总有可能被更长的链覆盖
- PBFT 的最终性是**确定性**的，一旦确认永不回滚

**教训**：
- 大额交易等更多确认
- 对最终性要求高的场景考虑确定性共识

### 坑 3：忽视 51% 攻击的成本变化

**错误想法**："51% 攻击需要控制一半算力，太难了"

**现实**：
- 算力可以租借（NiceHash 等）
- 小链的 51% 攻击成本可能只要几千美元
- 已经发生过多次：ETC、BTG 等都被攻击过

**教训**：
- 评估链的安全性要看攻击成本
- 使用小链时要特别注意

---

## 流程图定位

共识算法在区块链架构中的位置：

```
┌─────────────────────────────────────────────────────────────────┐
│                        区块链分层架构                            │
├─────────────────────────────────────────────────────────────────┤
│  应用层    │  DApp、智能合约、代币                               │
├─────────────────────────────────────────────────────────────────┤
│  合约层    │  EVM、WASM 虚拟机                                   │
├─────────────────────────────────────────────────────────────────┤
│ 【共识层】 │  PoW / PoS / PBFT ◀── 你在这里！                   │
│            │  决定谁来记账、如何达成一致                         │
├─────────────────────────────────────────────────────────────────┤
│  网络层    │  P2P、广播、节点发现                                │
├─────────────────────────────────────────────────────────────────┤
│  数据层    │  区块、交易、Merkle 树                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 自测题

### 基础题

1. **判断题**：所有区块链都使用 PoW 共识算法。（ ）
   <details>
   <summary>答案</summary>
   错误。不同区块链使用不同的共识算法，如以太坊 2.0 使用 PoS，Hyperledger Fabric 使用 PBFT 等。
   </details>

2. **选择题**：以下哪个共识算法具有确定性终局性？
   - A. PoW
   - B. PoS
   - C. PBFT
   - D. 以上都有
   <details>
   <summary>答案</summary>
   C。PBFT 一旦达成共识就是最终的，不会回滚。PoW 和 PoS 都是概率性终局，理论上可能被更长的链覆盖。
   </details>

3. **填空**：PBFT 可以容忍 ______ 的恶意节点，需要至少 ______ 的节点同意才能达成共识。
   <details>
   <summary>答案</summary>
   1/3（或 33%）；2/3（或 66.7%）
   </details>

### 思考题

4. **场景分析**：你要为一个银行间结算系统选择共识算法，参与者是 10 家已知银行。你会选择 PoW 还是 PBFT？为什么？

   <details>
   <summary>答案</summary>
   选择 PBFT。原因：
   1. 参与者已知且数量有限（10家），适合 PBFT
   2. 银行结算需要确定性终局，PBFT 可提供
   3. 银行有合规要求，不需要完全去中心化
   4. PBFT 性能更高，适合高频结算
   5. 无需消耗大量能源（PoW 的缺点）
   </details>

---

## 延伸阅读

- 下一篇：[PoW - 工作量证明](07-pow.md)
- 相关：[PoS - 权益证明](08-pos.md)
- 相关：[拜占庭将军问题](10-byzantine.md)
