# 提案与投票机制 (Proposal & Voting)

## 一句话大白话

**提案投票就是「网上股东大会」**：任何持有足够代币的人都可以提议案，所有代币持有者在线投票，结果自动执行。

---

## 它解决什么问题

### 核心痛点：决策如何民主又高效？

传统组织的困境：
- 老板一人决定：快但不民主
- 所有人开会讨论：民主但效率低下
- 股东大会：成本高、频率低、小股东没话语权

DAO 的方案：
- **链上提案**：任何人可提、透明可查
- **代币投票**：持有即有权、权重透明
- **自动执行**：通过即生效、无法抵赖

---

## 完整的提案生命周期

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        提案完整生命周期                                  │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐
│  讨论期   │──▶│  提案期   │──▶│  投票期   │──▶│  时间锁   │──▶│  执行期   │
│ (链下)   │   │ (链上)   │   │ (链上)   │   │ (等待)   │   │ (链上)   │
└──────────┘   └──────────┘   └──────────┘   └──────────┘   └──────────┘
    │              │              │              │              │
    ▼              ▼              ▼              ▼              ▼
 • 论坛帖子      • 正式提交      • 代币投票      • 安全缓冲      • 调用合约
 • 社区反馈      • 快照记录      • 赞成/反对     • 可取消窗口    • 状态变更
 • 温度检查      • 达到门槛      • 统计结果      • 准备执行      • 事件广播


详细状态流转：

                    ┌─────────────┐
                    │   Draft     │  草案（可选）
                    │   草案阶段   │
                    └──────┬──────┘
                           │ 正式提交
                           ▼
                    ┌─────────────┐
                    │   Pending   │  等待（可选）
                    │   等待期    │  等待投票开始
                    └──────┬──────┘
                           │ 开始投票
                           ▼
                    ┌─────────────┐
                    │   Active    │
                    │   投票中    │
                    └──────┬──────┘
                           │
          ┌────────────────┼────────────────┐
          │                │                │
          ▼                ▼                ▼
   ┌──────────┐     ┌──────────┐     ┌──────────┐
   │ Defeated │     │ Succeeded│     │ Canceled │
   │   否决    │     │   通过    │     │   取消   │
   └──────────┘     └────┬─────┘     └──────────┘
                         │ 进入时间锁
                         ▼
                  ┌──────────────┐
                  │    Queued    │
                  │   排队中     │
                  │  (时间锁)    │
                  └──────┬───────┘
                         │ 等待期结束
          ┌──────────────┼──────────────┐
          │              │              │
          ▼              ▼              ▼
   ┌──────────┐   ┌──────────┐   ┌──────────┐
   │ Expired  │   │ Executed │   │ Canceled │
   │   过期    │   │  已执行   │   │   取消   │
   └──────────┘   └──────────┘   └──────────┘
```

---

## 什么时候用 / 什么时候别用

### 适合用链上治理的决策

| 类型 | 例子 |
|------|------|
| 协议参数调整 | 修改手续费率、利率模型 |
| 资金支出 | 国库拨款、Grant 发放 |
| 合约升级 | 协议版本升级、安全修复 |
| 重大战略 | 合并、分叉、代币销毁 |

### 不适合用链上治理的决策

| 类型 | 原因 |
|------|------|
| 紧急安全修复 | 太慢，漏洞可能被利用 |
| 日常运营 | 太频繁，gas 费太高 |
| 主观判断 | 「这个设计好不好看」 |
| 需要保密 | 链上信息公开 |

---

## 它不是什么

### 常见误解

| 误解 | 真相 |
|------|------|
| ❌ 投票结果立刻执行 | 通常有时间锁（如 2 天） |
| ❌ 所有人都会投票 | 投票率通常只有 5-15% |
| ❌ 链上投票不要钱 | 链上投票需要 gas（链下投票如 Snapshot 免费） |
| ❌ 一人一票 | 大多数是「一币一票」 |
| ❌ 通过就一定执行 | 有的 DAO 有「否决权」机制 |

---

## 最小例子

### 例子1：查看提案信息

```javascript
// 使用 ethers.js 查看 Uniswap 提案

const governorContract = new ethers.Contract(
    governorAddress,
    governorABI,
    provider
);

// 提案 ID
const proposalId = "0x1234...";

// 查看提案状态
const state = await governorContract.state(proposalId);
const stateNames = [
    "Pending",    // 0: 等待
    "Active",     // 1: 投票中
    "Canceled",   // 2: 已取消
    "Defeated",   // 3: 被否决
    "Succeeded",  // 4: 已通过
    "Queued",     // 5: 排队中
    "Expired",    // 6: 已过期
    "Executed"    // 7: 已执行
];
console.log(`提案状态: ${stateNames[state]}`);

// 查看投票结果
const votes = await governorContract.proposalVotes(proposalId);
console.log(`赞成: ${ethers.utils.formatEther(votes.forVotes)}`);
console.log(`反对: ${ethers.utils.formatEther(votes.againstVotes)}`);
console.log(`弃权: ${ethers.utils.formatEther(votes.abstainVotes)}`);
```

### 例子2：参与投票

```javascript
// 投票（需要有投票权）

// 投票选项
const AGAINST = 0;  // 反对
const FOR = 1;      // 赞成
const ABSTAIN = 2;  // 弃权

// 投赞成票
const tx = await governorContract.castVote(proposalId, FOR);
await tx.wait();
console.log("投票成功！");

// 带理由的投票（会记录在链上）
const reason = "这个提案能提升协议收入";
const txWithReason = await governorContract.castVoteWithReason(
    proposalId,
    FOR,
    reason
);
await txWithReason.wait();
```

### 例子3：创建提案

```javascript
// 创建提案（需要达到提案门槛）

// 提案内容：调用国库合约，转 1000 USDC 给某地址
const targets = [treasuryAddress];           // 目标合约
const values = [0];                           // ETH 数量
const calldatas = [
    treasuryInterface.encodeFunctionData(
        "transfer",
        [recipientAddress, ethers.utils.parseUnits("1000", 6)]
    )
];                                            // 调用数据
const description = "给核心开发者发放 1000 USDC 月度薪资";

// 提交提案
const tx = await governorContract.propose(
    targets,
    values,
    calldatas,
    description
);
const receipt = await tx.wait();

// 获取提案 ID
const proposalId = receipt.events[0].args.proposalId;
console.log(`提案已创建，ID: ${proposalId}`);
```

---

## 关键概念深入

### 1. 提案门槛（Proposal Threshold）

**作用**：防止垃圾提案泛滥

```
常见门槛设置：

Uniswap:  250 万 UNI (0.25%)   │█░░░░░░░░░░░░░░░░░░░░░░│
Aave:     8 万 AAVE (0.05%)   │░░░░░░░░░░░░░░░░░░░░░░░│
Compound: 2.5 万 COMP (0.25%) │█░░░░░░░░░░░░░░░░░░░░░░│

门槛太高：只有鲸鱼能提案，普通人没话语权
门槛太低：垃圾提案泛滥，浪费社区精力
```

**解决方案：委托**

```
你有 1000 代币，门槛是 10 万
  │
  │  找到志同道合的人
  ▼
100 个人各有 1000 代币
  │
  │  都委托给你
  ▼
你的提案权 = 100 × 1000 = 10 万 ✓
```

### 2. 投票期（Voting Period）

**权衡点**：

```
投票期太短（如 1 天）：
  ✗ 很多人来不及参与
  ✗ 信息不对称
  ✗ 容易被突袭

投票期太长（如 30 天）：
  ✗ 决策效率低
  ✗ 市场变化可能让提案过时
  ✗ 用户疲劳

常见设置：3-7 天
```

### 3. 法定人数（Quorum）

**定义**：提案通过需要的最少参与票数

```
例子：Quorum = 4% 的总代币

总供应量：1 亿代币
Quorum：400 万代币

场景 A：
  赞成：300 万
  反对：50 万
  总参与：350 万 < 400 万
  结果：❌ 即使赞成票多，但未达法定人数，提案失败

场景 B：
  赞成：300 万
  反对：150 万
  总参与：450 万 > 400 万
  结果：✓ 达到法定人数，赞成 > 反对，提案通过
```

### 4. 时间锁（Timelock）

**作用**：给社区反应时间，防止恶意提案立即生效

```
提案通过
    │
    ▼
┌────────────────────────────────────┐
│          时间锁（如 2 天）           │
│                                    │
│  在此期间：                         │
│  • 社区检查提案内容                  │
│  • 发现问题可以组织反对              │
│  • 极端情况可触发紧急取消            │
│                                    │
└────────────────────────────────────┘
    │
    ▼
提案执行

为什么重要？
┌─────────────────────────────────────────────────┐
│ 案例：恶意提案「把国库所有资金转给我」           │
│                                                 │
│ 没有时间锁：通过后立即执行，资金被盗             │
│ 有时间锁：社区有 2 天发现问题、组织投票取消      │
└─────────────────────────────────────────────────┘
```

---

## 链上投票 vs 链下投票

| 特点 | 链上投票 | 链下投票（Snapshot） |
|------|---------|-------------------|
| Gas 费 | 每次投票都要付 | 完全免费 |
| 法律效力 | 直接执行 | 仅作为信号，需另行执行 |
| 安全性 | 区块链保证 | 依赖 Snapshot 平台 |
| 速度 | 受限于区块确认 | 秒级 |
| 适用场景 | 重大决策、资金操作 | 温度检查、社区调研 |

### Snapshot 投票流程

```
┌─────────────────────────────────────────────────────────────┐
│                    Snapshot 投票流程                        │
└─────────────────────────────────────────────────────────────┘

1. 创建空间（Space）
   └── 配置代币、投票策略

2. 发起提案
   └── 设置选项、投票时间

3. 投票（签名）
   ├── 用户用钱包签名（不上链）
   └── Snapshot 记录签名

4. 统计结果
   └── 按快照时的代币余额计算

5. 执行（需要另行操作）
   ├── 手动执行
   └── 或通过 SafeSnap 插件链接多签

特点：
• 零 gas 费
• 投票数据存在 IPFS
• 适合「先测温度，再正式提案」
```

---

## 新手最常踩的 3 个坑

### 坑 1：错过投票期

**场景**：
```
周一：提案创建
周二-周四：投票期
周五：提案执行/失败
你周六才看到：「啊？这么重要的提案我怎么没投票？」
```

**解决方案**：
- 关注 DAO 的 Discord/Twitter
- 使用 Tally/Boardroom 等聚合平台设置提醒
- 订阅治理论坛的邮件通知

### 坑 2：不理解「快照」时间

**场景**：
```
你周三买了 1 万代币，准备投票
提案的快照是周一
你的投票权：0（因为周一你还没有代币）
```

**教训**：投票权是在**提案创建时**快照的，不是投票时。

### 坑 3：以为弃权没用

**误解**：「弃权就是不投票嘛」

**真相**：弃权票的作用：
- 帮助达到法定人数（算作「参与」）
- 表达「我关注但不表态」的立场
- 某些规则下，弃权不计入赞成/反对比例

```
场景：Quorum 需要 100 万参与

赞成：60 万
反对：30 万
总参与：90 万 < 100 万 ❌ 未达法定人数

如果有 15 万弃权：
赞成：60 万
反对：30 万
弃权：15 万
总参与：105 万 > 100 万 ✓ 达到法定人数
赞成 > 反对，提案通过
```

---

## 流程图定位

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  创建DAO  │───▶│ 获取投票权│───▶│ 发起提案  │───▶│ 社区投票  │───▶│ 执行决策  │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
                                     ↑               ↑
                                     │               │
                              【提案与投票机制】 ──────┘
                                     │
                                     │
              ┌──────────────────────┴──────────────────────┐
              │                                             │
              ▼                                             ▼
        提案创建流程                                    投票流程
        • 达到门槛                                     • 投票期开始
        • 提交内容                                     • 链上/链下投票
        • 快照记录                                     • 统计结果
        • 等待投票                                     • 判定通过/否决
```

---

## 真实案例：ENS DAO 的提案流程

### ENS 治理流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                     ENS DAO 提案流程                                │
└─────────────────────────────────────────────────────────────────────┘

第一步：社区讨论（链下）
├── 在论坛发帖讨论想法
├── 收集社区反馈
└── 至少讨论 5 天

第二步：温度检查（Snapshot）
├── 发起 Snapshot 投票
├── 需要 100K ENS 参与
├── 投票期 5 天
└── 50% 以上支持才能继续

第三步：正式提案（链上）
├── 在治理合约创建提案
├── 需要 100K ENS 提案权
├── 投票期 7 天
└── 需要 1M ENS quorum + 50% 支持

第四步：执行
├── 进入时间锁（2 天）
└── 自动执行
```

### 案例：ENS 空投提案

```
提案：是否将 25% 的 ENS 代币空投给历史用户？

讨论期：
  社区热烈讨论
  主要争议：分配比例是否公平

温度检查（Snapshot）：
  赞成：85%
  反对：15%
  结果：通过 ✓

正式投票（链上）：
  赞成：约 500 万 ENS
  反对：约 50 万 ENS
  结果：通过 ✓

执行：
  数百万用户收到 ENS 空投
  价值数十亿美元
```

---

## 自测题

### 基础题

1. **判断题**：提案通过后会立即执行。（对/错）

2. **选择题**：以下哪个不是时间锁的作用？
   - A. 给社区发现问题的时间
   - B. 让提案通过更快
   - C. 防止恶意提案立即生效
   - D. 允许取消有问题的提案

3. **填空题**：提案需要达到 _______ 才能被认为有效，即使赞成票多于反对票。

### 进阶题

4. **计算题**：某 DAO 设置如下：
   - Quorum: 5%
   - 通过条件：赞成 > 反对
   - 总代币：1000 万枚

   以下投票结果，提案是否通过？
   - 赞成：40 万
   - 反对：20 万
   - 弃权：50 万

5. **思考题**：为什么很多 DAO 同时使用链下投票（Snapshot）和链上投票？

---

## 答案

1. **错**。大多数 DAO 有时间锁机制，提案通过后需要等待一段时间才能执行。

2. **B**。时间锁的作用是增加安全性，不是加快速度，实际上它会延迟执行。

3. **法定人数（Quorum）**

4. **通过** ✓
   - 总参与 = 40 + 20 + 50 = 110 万
   - Quorum = 1000 万 × 5% = 50 万
   - 110 万 > 50 万，达到法定人数 ✓
   - 赞成 40 万 > 反对 20 万 ✓
   - 两个条件都满足，提案通过

5. **链下 + 链上投票的组合好处**：
   - **链下（Snapshot）**：零成本试探社区态度，过滤低质量提案
   - **链上**：法律效力强，自动执行，不可抵赖
   - **流程**：先用 Snapshot 做「温度检查」，获得广泛支持后再花 gas 上链正式投票
   - **节省成本**：避免每个想法都上链投票（gas 费高）
   - **提高效率**：链下讨论充分后，链上投票通过率更高
