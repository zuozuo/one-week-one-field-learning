# 治理代币 (Governance Token)

## 一句话大白话

**治理代币就是「数字股东证」**：持有它，你就有权参与组织决策，持有越多，投票权越大。

---

## 它解决什么问题

### 核心痛点：谁有权做决定？

传统组织：
- 股东有投票权，但只有大股东才能参加股东大会
- 投票过程不透明，小散户的票可能被忽视
- 委托投票容易被操纵

DAO 的方案：
- **用代币代表投票权**，持有即有权
- **链上记录**，每一票都可追溯
- **任何持有者**都可以直接参与，无需中间人

### 为什么需要治理代币？

```
没有治理代币的 DAO：
┌────────────────────────────────────────┐
│ 问题：谁有投票权？                       │
│ • 任何人都能投票？→ 女巫攻击（一人多票）  │
│ • 管理员指定？→ 中心化，违背 DAO 精神     │
│ • 先到先得？→ 不公平                     │
└────────────────────────────────────────┘

有治理代币的 DAO：
┌────────────────────────────────────────┐
│ 解决方案：持币 = 投票权                  │
│ • 买入/赚取代币 → 获得投票权             │
│ • 代币数量 = 票数权重                    │
│ • 链上透明，无法伪造                     │
└────────────────────────────────────────┘
```

---

## 什么时候用 / 什么时候别用

### 适合发行治理代币

| 场景 | 说明 |
|------|------|
| 需要社区共同决策 | 协议升级、资金分配等 |
| 有真实价值支撑 | 协议有收入、国库有资金 |
| 需要激励贡献者 | 用代币奖励开发者、用户 |
| 追求去中心化 | 分散控制权给社区 |

### 不适合发行治理代币

| 场景 | 原因 |
|------|------|
| 项目早期、用户极少 | 治理变成几个人的游戏 |
| 没有什么可治理的 | 空壳治理，无实际意义 |
| 想保持快速迭代 | 每次改动都要投票，太慢 |
| 代币只是圈钱工具 | 缺乏长期价值，伤害用户 |

---

## 它不是什么

### 常见误解

| 误解 | 真相 |
|------|------|
| ❌ 治理代币 = 股票 | 大多数不分红，不代表所有权 |
| ❌ 持有就能决定一切 | 还要看投票规则、提案门槛等 |
| ❌ 越多越好 | 鲸鱼集中会导致「寡头治理」 |
| ❌ 价格高 = 治理好 | 价格和治理质量无直接关系 |
| ❌ 持有就会自动投票 | 需要主动参与或委托 |

### 治理代币 vs 普通代币

```
普通代币（如 USDT）              治理代币（如 UNI）
─────────────────────────────────────────────────────
主要用于交易/支付                主要用于投票/治理
持有无额外权益                   持有可参与决策
价值来自使用需求                 价值来自治理权 + 协议价值
通常无投票功能                   核心功能就是投票
```

---

## 最小例子

### 例子1：最简单的治理代币

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/token/ERC20/extensions/ERC20Votes.sol";

contract SimpleGovernanceToken is ERC20, ERC20Votes {
    constructor() ERC20("MyDAO Token", "MDAO") ERC20Permit("MyDAO Token") {
        // 铸造 1000 万枚代币给部署者
        _mint(msg.sender, 10_000_000 * 10**18);
    }

    // 以下是必要的重写函数
    function _afterTokenTransfer(
        address from,
        address to,
        uint256 amount
    ) internal override(ERC20, ERC20Votes) {
        super._afterTokenTransfer(from, to, amount);
    }

    function _mint(address to, uint256 amount)
        internal override(ERC20, ERC20Votes) {
        super._mint(to, amount);
    }

    function _burn(address account, uint256 amount)
        internal override(ERC20, ERC20Votes) {
        super._burn(account, amount);
    }
}
```

**这个代币有什么特点？**
- ERC20：标准代币功能（转账、余额查询）
- ERC20Votes：投票扩展（记录投票权、支持委托）

### 例子2：查看你的投票权

```javascript
// 使用 ethers.js 查询投票权
const tokenContract = new ethers.Contract(tokenAddress, tokenABI, provider);

// 查看代币余额
const balance = await tokenContract.balanceOf(myAddress);
console.log(`代币余额: ${ethers.utils.formatEther(balance)}`);

// 查看投票权（可能和余额不同！）
const votes = await tokenContract.getVotes(myAddress);
console.log(`投票权: ${ethers.utils.formatEther(votes)}`);

// 为什么可能不同？因为你可能：
// 1. 还没有「激活」投票权（需要 delegate）
// 2. 把投票权委托给了别人
```

### 例子3：委托投票权

```javascript
// 把投票权委托给自己（激活投票权）
await tokenContract.delegate(myAddress);

// 把投票权委托给别人（让他代你投票）
await tokenContract.delegate(delegateAddress);

// 注意：委托的是投票权，代币还在你手里
// 你随时可以：
// - 重新委托给别人
// - 委托回给自己
// - 转移代币（投票权随代币转移）
```

---

## 关键概念深入

### 1. 委托机制（Delegation）

**为什么需要委托？**

```
问题：大多数持有者不想/没时间参与每次投票
解决：把投票权委托给活跃的社区成员

┌─────────────────────────────────────────────────────┐
│                    委托流程                          │
├─────────────────────────────────────────────────────┤
│                                                     │
│   小明（持有 100 MDAO）                              │
│      │                                              │
│      │ 委托给                                       │
│      ▼                                              │
│   大佬 Alice（社区代表）                             │
│      │                                              │
│      │ Alice 现在有两份投票权：                      │
│      │ • 自己的 1000 MDAO                           │
│      │ • 小明委托的 100 MDAO                        │
│      │                                              │
│      ▼                                              │
│   投票时，Alice 的 1100 票都算数                     │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 2. 投票权快照（Snapshot）

**为什么需要快照？**

防止「闪电贷攻击」：

```
没有快照：
1. 攻击者借入大量代币（闪电贷，无需抵押）
2. 用借来的代币投票
3. 投完票立刻还回去
4. 几乎零成本操纵投票结果

有快照：
1. 提案创建时，记录那一刻所有人的代币余额
2. 投票时，按快照时的余额计票
3. 攻击者即使之后借入代币，也没有投票权
```

```solidity
// 快照机制示例
function propose(...) public {
    // 创建提案时记录当前区块
    uint256 snapshotBlock = block.number;

    // 存储快照区块
    proposals[proposalId].snapshotBlock = snapshotBlock;
}

function castVote(uint256 proposalId) public {
    // 投票时，查询快照时刻的余额
    uint256 snapshotBlock = proposals[proposalId].snapshotBlock;
    uint256 votes = token.getPastVotes(msg.sender, snapshotBlock);

    // 用快照时的余额计票，而非当前余额
}
```

### 3. 代币分配

**常见的代币分配模型：**

```
典型 DAO 代币分配示例：

┌────────────────────────────────────────────┐
│              代币分配比例                   │
├────────────────────────────────────────────┤
│                                            │
│   社区国库 (40%)  ████████████████         │
│   用于：提案奖励、生态发展、激励            │
│                                            │
│   团队 (20%)      ████████                 │
│   用于：核心开发者、顾问                    │
│   通常有锁定期（如 4 年）                   │
│                                            │
│   投资人 (15%)    ██████                   │
│   用于：早期投资者                          │
│   通常有锁定期（如 2 年）                   │
│                                            │
│   空投 (15%)      ██████                   │
│   用于：早期用户、社区贡献者                │
│                                            │
│   流动性 (10%)    ████                     │
│   用于：交易所流动性池                      │
│                                            │
└────────────────────────────────────────────┘
```

---

## 新手最常踩的 3 个坑

### 坑 1：买了代币却不能投票

**症状**：「我有 1000 个代币，为什么显示我投票权是 0？」

**原因**：很多治理代币需要「激活」投票权——即把投票权委托给自己。

**解决**：
```javascript
// 第一次持有代币后，需要做这一步
await tokenContract.delegate(myAddress);  // 委托给自己
```

**为什么这样设计？**
- 节省 gas：不是所有人都想参与治理
- 灵活性：方便委托给他人

### 坑 2：以为持有越多就一定能赢

**错误想法**：「我有 51% 的代币，我说了算」

**现实**：
- 很多 DAO 有「法定人数」要求（如必须 4% 代币参与）
- 有的提案需要「超级多数」（如 2/3 同意）
- 有「时间锁」让社区有时间反应
- 极端情况下，社区可以分叉

**案例**：Uniswap 曾有提案被鲸鱼支持，但因社区强烈反对而被撤回。

### 坑 3：忽视「投票权 ≠ 代币余额」

**场景**：
```
你在快照前有 1000 代币
快照后买入 500 代币
你的投票权：1000（不是 1500）

你把 500 代币委托给 Alice
你的代币余额：1000
你的投票权：500
Alice 因你增加的投票权：500
```

**教训**：投票权和代币余额是两个概念，要分开查询！

---

## 流程图定位

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  创建DAO  │───▶│ 获取投票权│───▶│ 发起提案  │───▶│ 社区投票  │───▶│ 执行决策  │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
     │               ↑               │               │
     │               │               │               │
     │          【治理代币】          │               │
     │               │               │               │
     ▼               │               ▼               ▼
创建代币合约 ────→ 持有代币 ────→ 达到提案门槛 ────→ 按代币权重计票
分配初始代币       委托激活        (如需 1% 代币)    (1 代币 = 1 票)
```

**治理代币在各阶段的作用：**

| 阶段 | 作用 |
|------|------|
| 创建 DAO | 决定代币总量、分配方案 |
| 获取投票权 | 持有 + 委托 = 投票权 |
| 发起提案 | 需要持有一定数量才能提案 |
| 社区投票 | 代币数量决定票数权重 |
| 执行决策 | 通常不直接参与，但可能需要质押 |

---

## 真实案例：UNI 代币

### 基本信息

| 属性 | 值 |
|------|-----|
| 代币名称 | Uniswap (UNI) |
| 总供应量 | 10 亿枚 |
| 提案门槛 | 250 万枚（0.25%） |
| 投票通过门槛 | 4000 万枚赞成票（4%） |

### 分配比例

```
UNI 代币分配：

社区 (60%)  ████████████████████████████████████████████████
├── 空投给历史用户 (15%)
├── 流动性挖矿 (2%)
└── 社区国库 (43%)

团队 (21.266%)  ██████████████████████
投资人 (18.044%)  ██████████████████
顾问 (0.69%)  █
```

### 关键设计

1. **空投**：对所有历史用户空投 400 UNI（体现「用户即所有者」）
2. **锁定期**：团队和投资人代币 4 年线性释放
3. **国库**：每年递减释放，保证长期发展资金

---

## 自测题

### 基础题

1. **判断题**：拥有治理代币后，投票权会自动生效。（对/错）

2. **选择题**：「投票权快照」主要是为了防止什么攻击？
   - A. 51% 攻击
   - B. 闪电贷攻击
   - C. 重入攻击
   - D. 女巫攻击

3. **填空题**：治理代币的委托机制允许持有者将 _______ 转让给他人，但代币本身 _______ 。

### 进阶题

4. **计算题**：某 DAO 的提案门槛是总量的 1%，总供应量是 1000 万枚。Alice 持有 5 万枚，Bob 持有 6 万枚，他们都把投票权委托给了 Carol。Carol 自己持有 1 万枚。Carol 能否发起提案？

5. **思考题**：为什么很多 DAO 选择空投代币给早期用户，而不是直接出售？

---

## 答案

1. **错**。大多数治理代币需要先「委托」（delegate）才能激活投票权，即使是委托给自己。

2. **B. 闪电贷攻击**。快照在提案创建时记录余额，攻击者无法在投票时临时借入代币获得投票权。

3. **投票权**、**不会转移/仍在自己手中**

4. **能**。Carol 的总投票权 = 5万 + 6万 + 1万 = 12万。门槛 = 1000万 × 1% = 10万。12万 > 10万，可以提案。

5. 空投的好处：
   - **公平分配**：奖励真正使用产品的人
   - **去中心化**：避免代币集中在少数买家手中
   - **社区认同**：用户变成「股东」，更有参与感
   - **避免证券问题**：空投比 ICO 在法律上更安全
   - **网络效应**：更多人持有 = 更多人关注 = 更大网络效应
