# 国库管理 (Treasury Management)

## 一句话大白话

**国库就是 DAO 的「公共钱包」**：所有人都能看到里面有多少钱，但花钱必须大家一起投票同意。

---

## 它解决什么问题

### 核心痛点：公共资金如何安全管理？

传统组织：
- 财务由几个人控制，其他人无法监督
- CFO 可能挪用资金，账本可能造假
- 小股东无权知道钱花到哪里了

DAO 的方案：
- **链上透明**：所有资金流动公开可查
- **集体决策**：花钱必须通过提案投票
- **程序执行**：通过后自动转账，无法偷偷修改

---

## 国库的资金来源

```
┌─────────────────────────────────────────────────────────────────────┐
│                        国库资金来源                                  │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   协议收入   │     │   代币销售   │     │   捐赠收入   │
│  Protocol   │     │   Token     │     │  Donations  │
│  Revenue    │     │   Sale      │     │             │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       └───────────────────┼───────────────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │                 │
                  │     国  库      │
                  │   (Treasury)    │
                  │                 │
                  │  ETH, USDC,     │
                  │  代币, NFT...   │
                  │                 │
                  └─────────────────┘

具体来源：

1. 协议收入
   ├── 交易手续费（如 Uniswap 的 LP 费用）
   ├── 借贷利息（如 Aave 的利差）
   ├── 清算罚金
   └── 其他协议收益

2. 代币销售/分配
   ├── 创世分配时预留的国库份额
   ├── 增发的代币
   └── 未领取的空投（回收）

3. 其他来源
   ├── 生态项目捐赠
   ├── 合作方付款
   └── NFT 销售收入
```

---

## 国库的资金用途

```
┌─────────────────────────────────────────────────────────────────────┐
│                        国库资金用途                                  │
└─────────────────────────────────────────────────────────────────────┘

                  ┌─────────────────┐
                  │                 │
                  │     国  库      │
                  │   (Treasury)    │
                  │                 │
                  └────────┬────────┘
                           │
       ┌───────────────────┼───────────────────┐
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  开发建设    │     │  生态激励    │     │  运营支出    │
│Development  │     │ Incentives  │     │ Operations  │
└─────────────┘     └─────────────┘     └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
• 核心开发       • 流动性挖矿      • 审计费用
• 安全审计       • Grant 资助      • 法律费用
• 基础设施       • 黑客松奖金      • 市场营销
• 前端开发       • 社区贡献者      • 社区活动


常见支出类型及比例（示例）：

开发建设 (40%)    ████████████████████████████████████████
├── 核心协议开发
├── 安全审计
└── 基础设施

生态激励 (35%)    ███████████████████████████████████
├── 流动性激励
├── 开发者 Grant
└── 用户增长

运营支出 (20%)    ████████████████████
├── 服务商费用
├── 市场活动
└── 法律合规

储备金 (5%)       █████
└── 应急资金
```

---

## 什么时候用 / 什么时候别用

### 适合通过国库支出的场景

| 场景 | 理由 |
|------|------|
| 定期开发者薪资 | 可预测、可审计 |
| 安全漏洞赏金 | 保护协议安全 |
| 生态 Grant 资助 | 促进生态发展 |
| 流动性激励 | 提升协议使用率 |

### 不适合通过国库支出的场景

| 场景 | 理由 |
|------|------|
| 模糊的「市场费用」 | 容易被滥用 |
| 给特定人的大额奖励 | 有利益输送嫌疑 |
| 没有明确可交付物的项目 | 难以追责 |
| 投机性投资 | 超出 DAO 能力范围 |

---

## 它不是什么

### 常见误解

| 误解 | 真相 |
|------|------|
| ❌ 国库的钱随便花 | 每笔支出都需要提案通过 |
| ❌ 国库只能存 ETH | 可以存各种代币、NFT、LP 份额 |
| ❌ 国库越大越好 | 过多资金闲置是浪费，需要合理运营 |
| ❌ 国库管理很简单 | 涉及投资、风险管理、合规等复杂问题 |
| ❌ 核心团队可以动用国库 | 同样需要走治理流程 |

---

## 最小例子

### 例子1：查看国库余额

```javascript
// 查看 DAO 国库的 ETH 和代币余额

const provider = new ethers.providers.JsonRpcProvider(rpcUrl);

// 国库地址（通常是多签或治理合约控制的地址）
const treasuryAddress = "0x1234...";

// 查看 ETH 余额
const ethBalance = await provider.getBalance(treasuryAddress);
console.log(`ETH: ${ethers.utils.formatEther(ethBalance)}`);

// 查看 USDC 余额
const usdcContract = new ethers.Contract(usdcAddress, erc20ABI, provider);
const usdcBalance = await usdcContract.balanceOf(treasuryAddress);
console.log(`USDC: ${ethers.utils.formatUnits(usdcBalance, 6)}`);

// 查看治理代币余额
const tokenContract = new ethers.Contract(tokenAddress, erc20ABI, provider);
const tokenBalance = await tokenContract.balanceOf(treasuryAddress);
console.log(`DAO Token: ${ethers.utils.formatEther(tokenBalance)}`);
```

### 例子2：提案从国库拨款

```javascript
// 创建提案：从国库转 10,000 USDC 给开发团队

const targets = [usdcAddress];  // USDC 合约地址
const values = [0];              // 不发送 ETH
const calldatas = [
    usdcInterface.encodeFunctionData(
        "transfer",
        [
            developerMultisig,  // 接收地址
            ethers.utils.parseUnits("10000", 6)  // 10,000 USDC
        ]
    )
];
const description = `
## 提案：第三季度开发团队拨款

### 概述
向核心开发团队拨付 10,000 USDC，用于 Q3 开发工作。

### 资金用途
- 智能合约开发: 4,000 USDC
- 前端开发: 3,000 USDC
- 安全审计: 3,000 USDC

### 交付物
- 协议 V2 升级
- 新增 3 个交易对
- 完成 Trail of Bits 审计

### 时间线
- 开始: 2024-07-01
- 结束: 2024-09-30
`;

// 提交提案
const tx = await governorContract.propose(
    targets,
    values,
    calldatas,
    description
);
```

### 例子3：简单的国库合约

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";

contract SimpleTreasury is Ownable {
    // 事件记录
    event Deposit(address indexed token, address indexed from, uint256 amount);
    event Withdrawal(address indexed token, address indexed to, uint256 amount);

    // 接收 ETH
    receive() external payable {
        emit Deposit(address(0), msg.sender, msg.value);
    }

    // 存入代币
    function depositToken(address token, uint256 amount) external {
        IERC20(token).transferFrom(msg.sender, address(this), amount);
        emit Deposit(token, msg.sender, amount);
    }

    // 取出 ETH（只有 owner 可以，实际中是 Governor 合约）
    function withdrawETH(address payable to, uint256 amount) external onlyOwner {
        to.transfer(amount);
        emit Withdrawal(address(0), to, amount);
    }

    // 取出代币
    function withdrawToken(
        address token,
        address to,
        uint256 amount
    ) external onlyOwner {
        IERC20(token).transfer(to, amount);
        emit Withdrawal(token, to, amount);
    }

    // 查看 ETH 余额
    function ethBalance() external view returns (uint256) {
        return address(this).balance;
    }

    // 查看代币余额
    function tokenBalance(address token) external view returns (uint256) {
        return IERC20(token).balanceOf(address(this));
    }
}
```

---

## 国库管理的进阶概念

### 1. 资产多元化

**为什么要多元化？**

```
风险场景：国库 100% 是自家代币

代币价格 $10 → 国库价值 1000 万美元
代币价格 $1  → 国库价值 100 万美元（跌 90%）

此时需要支付开发费用，却发现：
- 卖代币会进一步砸盘
- 买家不愿意接盘
- 运营陷入困境
```

**多元化策略：**

```
典型的国库资产配置：

原生代币 (40%)    ████████████████████████████████████████
├── 用于生态激励
└── 保留治理控制力

稳定币 (30%)      ██████████████████████████████
├── USDC
├── DAI
└── 用于日常运营支出

ETH (20%)         ████████████████████
├── 支付 gas
└── 价值储存

收益资产 (10%)    ██████████
├── LP 份额
├── 借贷存款
└── 国债代币
```

### 2. 国库收益化

**问题**：国库资金闲置是浪费

**解决方案**：

```
┌─────────────────────────────────────────────────────────────────┐
│                    国库收益化策略                                │
└─────────────────────────────────────────────────────────────────┘

低风险策略：
├── 稳定币存入 Aave/Compound → 年化 2-5%
├── 提供稳定币流动性 → 交易手续费
└── 购买国债代币 → 无风险利率

中等风险：
├── ETH 质押 → 年化 4-5%
├── 提供波动性资产流动性 → 高手续费 + 无常损失风险
└── 参与其他协议治理 → 获取空投

高风险（通常不建议）：
├── 杠杆策略
├── 投资早期项目
└── 复杂 DeFi 策略
```

### 3. 财务透明度

**最佳实践：**

```
定期财务报告内容：

1. 资产负债表
   ├── 当前持有资产明细
   ├── 各类资产占比
   └── 资产估值（按当前价格）

2. 收支报表
   ├── 本期收入（协议费用、代币销售等）
   ├── 本期支出（开发、运营、激励等）
   └── 净流入/流出

3. 拨款追踪
   ├── 已批准但未执行的提案
   ├── 已执行拨款的使用情况
   └── 里程碑完成度

4. 风险披露
   ├── 集中度风险
   ├── 智能合约风险
   └── 市场风险

示例工具：
• Dune Analytics 仪表盘
• 定期社区报告
• 链上可验证的数据
```

---

## 新手最常踩的 3 个坑

### 坑 1：把「国库有钱」等同于「项目有价值」

**错误想法**：「这个 DAO 国库有 1 亿美元，很厉害」

**现实**：
- 国库 80% 可能是自家代币（市值高但流动性差）
- 代币价格暴跌时，国库缩水但支出不变
- 真正的健康指标是「稳定币储备能支撑多久运营」

**更好的指标**：
```
运营跑道 = 稳定币储备 ÷ 月度支出

例如：
稳定币储备：300 万 USDC
月度支出：20 万 USDC
运营跑道：15 个月

这比「总资产 1 亿」更有意义
```

### 坑 2：支持无明确交付物的提案

**危险信号**：
```
❌ 「申请 50 万美元用于市场推广」
  → 推广什么？怎么衡量效果？钱给谁？

✓ 「申请 5 万美元用于 Twitter 广告」
  → 明确渠道
  → 「目标：增加 10,000 关注」
  → 「分 3 次付款，按效果付款」
  → 给具体服务商
```

**好提案的特征**：
- 明确的金额和用途
- 可衡量的交付物
- 分阶段付款
- 负责人和联系方式

### 坑 3：忽视国库安全风险

**常见风险**：

```
1. 智能合约风险
   └── 国库合约被黑 → 资金被盗

2. 治理攻击风险
   └── 恶意提案通过 → 资金被转走

3. 私钥风险（多签情况）
   └── 多签成员私钥泄露 → 达到门槛后被盗

4. 社工攻击
   └── 伪装成合法提案 → 骗取拨款

防护措施：
• 多签 + 时间锁
• 单次拨款上限
• 重大金额需更高法定人数
• 专业安全审计
```

---

## 流程图定位

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  创建DAO  │───▶│ 获取投票权│───▶│ 发起提案  │───▶│ 社区投票  │───▶│ 执行决策  │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
     │                               │                               │
     │                               │                               │
     └────────────【国库】────────────┴───────────────────────────────┘
                    │
         ┌─────────┴─────────┐
         │                   │
         ▼                   ▼
    资金来源             资金支出
    • 协议收入           • 通过提案批准
    • 代币分配           • 治理合约执行
    • 社区捐赠           • 转入目标地址


国库在 DAO 中的位置：

┌─────────────────────────────────────────────────────────────────────┐
│                         DAO 架构                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────┐                                                   │
│   │  治理代币    │◄───── 持有者投票                                 │
│   └──────┬──────┘                                                   │
│          │                                                          │
│          ▼                                                          │
│   ┌─────────────┐       ┌─────────────┐                            │
│   │  治理合约    │──────▶│   时间锁    │                            │
│   │ (Governor)  │       │ (Timelock)  │                            │
│   └─────────────┘       └──────┬──────┘                            │
│                                │                                    │
│                                ▼                                    │
│                       ┌─────────────┐                              │
│                       │    国库     │◄───── 你在这里学习            │
│                       │ (Treasury)  │                              │
│                       └─────────────┘                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 真实案例：Uniswap Grants Program

### 背景

Uniswap 国库持有约 30 亿美元（大部分是 UNI 代币），通过 Grants Program 资助生态项目。

### Grants 流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                  Uniswap Grants 申请流程                            │
└─────────────────────────────────────────────────────────────────────┘

第一步：提交申请
├── 填写申请表（项目介绍、团队、预算）
├── 说明与 Uniswap 生态的关系
└── 提供里程碑计划

第二步：初审
├── Grants 委员会审核
├── 评估可行性和价值
└── 可能要求补充材料

第三步：社区反馈
├── 在论坛公示申请
├── 收集社区意见
└── 回应质疑

第四步：委员会投票
├── 委员会成员投票
├── 多数通过即批准
└── 大额需要链上治理

第五步：拨款执行
├── 签署协议
├── 分期付款（按里程碑）
└── 定期进度汇报
```

### 典型资助案例

```
案例：资助 Uniswap 前端开发

申请金额：50,000 USDC
申请方：Interface Labs

资金用途：
├── 前端性能优化: 20,000 USDC
├── 移动端适配: 15,000 USDC
└── 新功能开发: 15,000 USDC

交付物：
├── 加载速度提升 50%
├── 移动端完整功能
└── 限价单功能

付款计划：
├── 批准后: 15,000 USDC（启动资金）
├── 里程碑 1: 15,000 USDC
├── 里程碑 2: 10,000 USDC
└── 最终验收: 10,000 USDC
```

---

## 自测题

### 基础题

1. **判断题**：DAO 核心团队可以不经提案直接使用国库资金。（对/错）

2. **选择题**：以下哪个不是国库资金的典型来源？
   - A. 协议交易手续费
   - B. 代币空投给国库
   - C. 成员个人存款
   - D. 生态项目捐赠

3. **填空题**：国库健康的重要指标是 _______ ，即稳定币储备除以月度支出。

### 进阶题

4. **分析题**：某 DAO 国库价值 1 亿美元，其中 95% 是自家代币，5% 是 USDC。月度支出 50 万美元。请分析这个国库的风险和改进建议。

5. **思考题**：为什么大多数 DAO 选择将国库置于时间锁控制之下，而不是直接由治理合约控制？

---

## 答案

1. **错**。即使是核心团队，使用国库资金也需要通过治理提案获得批准。这是 DAO 去中心化的核心原则。

2. **C. 成员个人存款**。国库资金来源是协议收入、代币分配和捐赠，不是成员个人存款。个人持有的是自己的资产，不是国库的一部分。

3. **运营跑道（Runway）**

4. **风险分析**：
   - 严重的集中度风险：95% 是自家代币
   - 如果代币下跌 80%，国库价值变成 2500 万（其中代币 2000 万，USDC 500 万）
   - USDC 只有 500 万，运营跑道仅 10 个月
   - 需要卖代币支付运营费用，可能导致价格进一步下跌

   **改进建议**：
   - 逐步多元化，将部分代币换成稳定币
   - 目标：稳定币储备至少覆盖 18-24 个月运营
   - 考虑将部分资产放入收益协议
   - 建立明确的资产配置政策

5. **时间锁的作用**：
   - **安全缓冲**：恶意提案通过后，社区有时间发现问题
   - **紧急响应**：可以在执行前取消有问题的提案
   - **透明预告**：所有人都能提前知道将要发生的变化
   - **合规需求**：某些司法管辖区要求有冷静期
   - **防止闪电攻击**：攻击者无法在一个交易中完成攻击和执行
