# 多签钱包 (Multisig Wallet)

## 一句话大白话

**多签钱包就是「保险柜双钥匙」**：必须多个人同时签名才能动钱，一个人偷不走、弄丢也不怕。

---

## 它解决什么问题

### 核心痛点：单点故障风险

**传统钱包的风险**：
```
普通钱包（单签）
    │
    │ 私钥
    ▼
┌─────────────────────────────────────┐
│  风险 1：私钥泄露 → 资金被盗        │
│  风险 2：私钥丢失 → 资金永远丢失    │
│  风险 3：持有人作恶 → 无人能阻止    │
└─────────────────────────────────────┘
```

**多签钱包的解决方案**：
```
多签钱包（如 3/5）
    │
    │ 需要 5 个人中的 3 个签名
    ▼
┌─────────────────────────────────────┐
│  ✓ 1 个私钥泄露 → 资金仍安全        │
│  ✓ 1 个私钥丢失 → 其他人可恢复      │
│  ✓ 1 人想作恶 → 需要说服另外 2 人   │
└─────────────────────────────────────┘
```

---

## 什么是 M/N 多签

```
M/N 多签 = M of N = 「N 个签名者中，需要 M 个签名」

常见配置：

2/3 多签
├── 3 个签名者
├── 需要 2 个签名
└── 适合：小型团队、个人资产保护

3/5 多签
├── 5 个签名者
├── 需要 3 个签名
└── 适合：中型项目、DAO 国库

4/7 多签
├── 7 个签名者
├── 需要 4 个签名
└── 适合：大型项目、重要合约升级权限

5/9 多签
├── 9 个签名者
├── 需要 5 个签名
└── 适合：头部协议、数十亿美金资产


设计原则：

门槛太低（如 1/5）：
  ✗ 单人就能作恶
  ✗ 失去多签意义

门槛太高（如 5/5）：
  ✗ 一人失联就无法操作
  ✗ 效率太低

最佳实践：
  • 门槛 > 50%（如 3/5, 4/7）
  • 签名者 > 3 人（分散风险）
  • 签名者来自不同组织/地域（避免共谋）
```

---

## 什么时候用 / 什么时候别用

### 适合用多签的场景

| 场景 | 推荐配置 | 理由 |
|------|---------|------|
| DAO 国库 | 4/7 或 5/9 | 高价值资产需要高安全性 |
| 团队资金 | 2/3 或 3/5 | 平衡安全性和效率 |
| 合约升级权限 | 3/5+ | 防止单人修改合约 |
| 个人大额资产 | 2/3 | 自己 + 信任的人 |

### 不适合用多签的场景

| 场景 | 原因 |
|------|------|
| 日常小额交易 | 每次都要多人签名，太麻烦 |
| 高频交易 | 签名延迟影响时效性 |
| 需要紧急响应 | 可能找不齐人签名 |
| 完全匿名的组织 | 无法信任签名者身份 |

---

## 它不是什么

### 常见误解

| 误解 | 真相 |
|------|------|
| ❌ 多签绝对安全 | 如果超过门槛的签名者串通，仍可被盗 |
| ❌ 多签很复杂 | Safe 等工具让多签非常简单 |
| ❌ 多签费用很高 | 和普通交易差不多（稍多一点 gas） |
| ❌ 签名者能看到私钥 | 每人只持有自己的私钥 |
| ❌ 多签只能管 ETH | 可以管理任何代币、NFT、调用任何合约 |

### 多签 vs 社交恢复钱包

```
多签钱包：
├── 每次操作都需要多人签名
├── 签名者权力相等
└── 适合组织

社交恢复钱包（如 Argent）：
├── 日常操作只需自己
├── 恢复时才需要「守护者」帮助
└── 适合个人
```

---

## 最小例子

### 例子1：使用 Safe（原 Gnosis Safe）创建多签

```
步骤 1：访问 https://app.safe.global/

步骤 2：连接钱包，选择网络

步骤 3：点击「Create new Safe」

步骤 4：添加签名者
┌─────────────────────────────────────────┐
│  Signer 1: 0xAlice...（你自己）          │
│  Signer 2: 0xBob...（合作伙伴）          │
│  Signer 3: 0xCharlie...（顾问）          │
└─────────────────────────────────────────┘

步骤 5：设置门槛
┌─────────────────────────────────────────┐
│  Threshold: 2 of 3                       │
│  （3 个签名者中需要 2 个签名）            │
└─────────────────────────────────────────┘

步骤 6：确认并部署（支付 gas）

步骤 7：保存多签地址
```

### 例子2：发起一笔多签交易

```javascript
// 使用 Safe SDK 发起交易

import Safe from '@safe-global/safe-core-sdk';
import { ethers } from 'ethers';

// 连接到已有的 Safe
const safeSdk = await Safe.create({
    ethAdapter,
    safeAddress: '0xYourSafeAddress...'
});

// 创建交易
const safeTransaction = await safeSdk.createTransaction({
    safeTransactionData: {
        to: recipientAddress,
        value: ethers.utils.parseEther('1.0').toString(),
        data: '0x'  // 纯转账，无调用数据
    }
});

// 第一个签名者签名
const signedTx = await safeSdk.signTransaction(safeTransaction);

// 提交到 Safe Transaction Service（等待其他人签名）
await safeService.proposeTransaction({
    safeAddress,
    safeTransactionData: signedTx.data,
    safeTxHash: await safeSdk.getTransactionHash(signedTx),
    senderAddress: ownerAddress,
    senderSignature: signedTx.signatures.get(ownerAddress.toLowerCase())
});

console.log('交易已提交，等待其他签名者签名...');
```

### 例子3：其他签名者确认并执行

```javascript
// 获取待签名的交易
const pendingTxs = await safeService.getPendingTransactions(safeAddress);

// 选择要签名的交易
const txToSign = pendingTxs.results[0];

// 签名
const signature = await safeSdk.signTransactionHash(txToSign.safeTxHash);

// 添加签名
await safeService.confirmTransaction(txToSign.safeTxHash, signature.data);

// 检查是否达到门槛
if (txToSign.confirmations.length + 1 >= threshold) {
    // 达到门槛，执行交易
    const executeTxResponse = await safeSdk.executeTransaction(safeTransaction);
    await executeTxResponse.transactionResponse?.wait();
    console.log('交易已执行！');
} else {
    console.log('等待更多签名...');
}
```

---

## Safe 多签钱包详解

### 为什么 Safe 是行业标准？

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Safe（原 Gnosis Safe）                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  市场地位：                                                         │
│  • 管理资产超过 1000 亿美元                                         │
│  • 被 Uniswap、Aave、ENS 等顶级项目使用                            │
│  • 行业事实标准                                                     │
│                                                                     │
│  核心功能：                                                         │
│  • 多签管理（M/N 配置）                                             │
│  • 支持所有 ERC-20 代币和 NFT                                       │
│  • 可调用任意智能合约                                               │
│  • 交易批处理（省 gas）                                             │
│  • 支持硬件钱包                                                     │
│                                                                     │
│  高级功能：                                                         │
│  • Safe Apps（内置 DeFi 应用）                                      │
│  • 模块系统（可扩展功能）                                           │
│  • 支持 EIP-1271（合约签名）                                        │
│  • 多链支持                                                         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Safe 的工作流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Safe 交易流程                                   │
└─────────────────────────────────────────────────────────────────────┘

第一步：创建交易
┌──────────────┐
│  Alice 创建  │
│  转账 10 ETH │
│  给 0x123... │
└──────┬───────┘
       │
       ▼
第二步：签名收集
┌──────────────────────────────────────────────────────────┐
│                                                          │
│    Alice ✓     Bob ⏳      Charlie ⏳                    │
│    (已签名)    (待签名)    (待签名)                       │
│                                                          │
│    门槛：2/3                                             │
│    当前签名：1/2                                         │
│                                                          │
└──────────────────────────────────────────────────────────┘
       │
       │ Bob 签名
       ▼
第三步：达到门槛
┌──────────────────────────────────────────────────────────┐
│                                                          │
│    Alice ✓     Bob ✓       Charlie ⏳                    │
│    (已签名)    (已签名)    (未签名)                       │
│                                                          │
│    门槛：2/3                                             │
│    当前签名：2/2 ✓ 可执行                                │
│                                                          │
└──────────────────────────────────────────────────────────┘
       │
       │ 任意签名者执行
       ▼
第四步：链上执行
┌──────────────┐
│  交易上链    │
│  10 ETH 转出 │
│  状态：成功  │
└──────────────┘
```

### Safe Apps 生态

```
常用 Safe Apps：

DeFi 类：
├── WalletConnect：连接外部 DApp
├── Aave：借贷操作
├── Uniswap：代币交换
├── Compound：借贷操作
└── Yearn：收益聚合

治理类：
├── Snapshot：链下投票
├── Tally：链上治理
└── Boardroom：治理聚合

工具类：
├── CSV Airdrop：批量空投
├── Transaction Builder：构建复杂交易
└── Safe Stats：资产统计
```

---

## 多签的安全考量

### 签名者选择

```
最佳实践：

1. 身份多元化
   ✓ 不同组织的人（避免公司跑路风险）
   ✓ 不同地区的人（避免地域风险）
   ✓ 不同角色（开发者、投资人、顾问）

2. 技术能力
   ✓ 懂得安全保管私钥
   ✓ 能及时响应签名请求
   ✓ 了解基本的交易验证

3. 信誉背书
   ✓ 有公开身份或声誉
   ✓ 在社区有利益绑定
   ✓ 作恶成本高

警惕信号：
✗ 所有签名者来自同一公司
✗ 签名者完全匿名
✗ 门槛设置过低
✗ 签名者长期不活跃
```

### 常见攻击向量

```
攻击 1：社工攻击
┌─────────────────────────────────────────────────────────┐
│ 攻击者伪装成「紧急安全修复」要求签名                      │
│                                                         │
│ 防御：                                                  │
│ • 任何交易都要验证目标地址和金额                        │
│ • 使用官方渠道沟通                                      │
│ • 不因「紧急」而放松验证                                │
└─────────────────────────────────────────────────────────┘

攻击 2：私钥窃取
┌─────────────────────────────────────────────────────────┐
│ 攻击者通过钓鱼/恶意软件窃取超过门槛数量的私钥            │
│                                                         │
│ 防御：                                                  │
│ • 使用硬件钱包                                          │
│ • 签名者使用不同的设备和软件                            │
│ • 定期更换签名者                                        │
└─────────────────────────────────────────────────────────┘

攻击 3：内部共谋
┌─────────────────────────────────────────────────────────┐
│ 超过门槛的签名者联合作恶                                 │
│                                                         │
│ 防御：                                                  │
│ • 签名者来自不同利益方                                  │
│ • 时间锁给社区反应时间                                  │
│ • 公开透明的签名记录                                    │
└─────────────────────────────────────────────────────────┘
```

---

## 新手最常踩的 3 个坑

### 坑 1：门槛设置不合理

**常见错误**：

```
错误 1：门槛太低
设置：1/5 多签
问题：一个人就能转走所有资金，失去多签意义

错误 2：门槛太高
设置：5/5 多签
问题：一人失联，资金就永远锁死

错误 3：签名者太少
设置：2/2 多签
问题：没有容错空间，一人出问题就完蛋
```

**推荐配置**：
- 最少 3 个签名者
- 门槛 > 50% 且 < 100%
- 如 2/3, 3/5, 4/7, 5/9

### 坑 2：不验证交易详情

**危险场景**：

```
收到签名请求：
「紧急！安全漏洞！请立即签名这笔交易！」

你没仔细看：
• 目标地址是什么？
• 调用的是什么函数？
• 参数是什么？

结果：
签名了一笔「把所有资金转给攻击者」的交易
```

**正确做法**：

```
每次签名前必须确认：

1. 目标地址
   • 是不是预期的合约/地址？
   • 在 Etherscan 上验证过吗？

2. 交易内容
   • 调用什么函数？（transfer? approve? 未知函数?）
   • 参数是什么？（金额、接收者）

3. 来源验证
   • 通过官方渠道确认交易真实性
   • 如有疑问，先问清楚再签

4. 模拟执行
   • 使用 Tenderly 等工具模拟交易结果
   • 确认结果符合预期
```

### 坑 3：签名者管理不善

**问题场景**：

```
场景 1：签名者失联
├── 某签名者换工作后不再响应
├── 长期找不到人签名
└── 紧急操作无法执行

场景 2：私钥管理混乱
├── 签名者忘记私钥存在哪
├── 没有备份
└── 需要签名时无法签

场景 3：权限没有更新
├── 离职员工仍是签名者
├── 不再参与的顾问仍有权限
└── 安全隐患
```

**最佳实践**：

```
1. 定期活跃检查
   • 每月做一次「签名演练」
   • 确认所有签名者都能正常签名

2. 明确的轮换机制
   • 签名者变动时及时更新
   • 有明确的添加/移除流程

3. 文档化
   • 记录每个签名者的联系方式
   • 记录紧急情况的处理流程

4. 备份方案
   • 签名者应有私钥备份
   • 考虑使用硬件钱包
```

---

## 流程图定位

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  创建DAO  │───▶│ 获取投票权│───▶│ 发起提案  │───▶│ 社区投票  │───▶│ 执行决策  │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
                                                                     │
                                                                     │
                                                                     ▼
                                                              ┌──────────┐
                                                              │ 时间锁   │
                                                              └────┬─────┘
                                                                   │
                                                                   ▼
                                                              ┌──────────┐
                                                              │  多签    │←── 你在这里
                                                              │ 执行交易 │
                                                              └────┬─────┘
                                                                   │
                                                                   ▼
                                                              ┌──────────┐
                                                              │   国库   │
                                                              │ 资金转出 │
                                                              └──────────┘


多签在 DAO 架构中的位置：

┌─────────────────────────────────────────────────────────────────────┐
│                        典型 DAO 安全架构                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                        ┌─────────────┐                              │
│                        │  治理投票    │                              │
│                        └──────┬──────┘                              │
│                               │                                     │
│                               ▼                                     │
│                        ┌─────────────┐                              │
│                        │   时间锁    │  ← 第一道防线：等待期        │
│                        │  (2-7 天)   │                              │
│                        └──────┬──────┘                              │
│                               │                                     │
│                               ▼                                     │
│                        ┌─────────────┐                              │
│                        │   多签执行   │  ← 第二道防线：多人确认     │
│                        │  (如 4/7)   │                              │
│                        └──────┬──────┘                              │
│                               │                                     │
│                               ▼                                     │
│                        ┌─────────────┐                              │
│                        │  国库/合约  │                              │
│                        └─────────────┘                              │
│                                                                     │
│   为什么需要两道防线？                                              │
│   • 时间锁：让社区有时间发现问题                                    │
│   • 多签：即使恶意提案通过，还需说服多签成员执行                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 真实案例：Ronin Bridge 被盗事件

### 事件背景

2022 年 3 月，Ronin Network（Axie Infinity 的侧链）被盗 6.25 亿美元，是 DeFi 历史上最大的黑客事件之一。

### 问题出在哪？

```
Ronin Bridge 的多签配置：

签名者：9 个
门槛：5/9（需要 5 个签名）

问题：
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  签名者 1-4：Sky Mavis（开发公司）控制                              │
│  签名者 5：Axie DAO（但 Sky Mavis 有临时权限）                      │
│  签名者 6-9：其他验证者                                             │
│                                                                     │
│  实际上：Sky Mavis 一家公司控制了 5 个签名者                        │
│  → 形同单签！                                                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

攻击过程：
1. 攻击者通过钓鱼获取了 Sky Mavis 员工的访问权限
2. 获取了 4 个 Sky Mavis 控制的私钥
3. 利用过期未撤销的 Axie DAO 权限获取第 5 个签名
4. 达到 5/9 门槛，转走全部资金
5. 攻击后 6 天才被发现
```

### 教训

```
教训 1：签名者必须真正独立
✗ 同一公司控制多个签名者 = 形同单签
✓ 签名者应来自不同组织

教训 2：权限要及时撤销
✗ Axie DAO 的临时权限未被撤销
✓ 临时授权用完必须立即撤销

教训 3：需要监控和告警
✗ 攻击后 6 天才发现
✓ 大额转账应有即时告警

教训 4：门槛设置要合理
✗ 5/9 看起来不错，但实际 5 个由一家控制
✓ 要关注「有效签名者数量」而非表面数字
```

---

## 自测题

### 基础题

1. **判断题**：3/5 多签意味着需要 5 个签名者中的 3 个签名才能执行交易。（对/错）

2. **选择题**：以下哪种多签配置最不安全？
   - A. 2/3
   - B. 3/5
   - C. 1/5
   - D. 4/7

3. **填空题**：Safe（原 Gnosis Safe）是目前最流行的多签钱包，管理的资产超过 _______ 美元。

### 进阶题

4. **设计题**：你的 DAO 有 1000 万美元资产，核心团队 3 人，投资人 2 人，顾问 2 人。请设计一个多签方案，说明签名者选择和门槛设置的理由。

5. **分析题**：如果一个 4/7 多签的 3 个签名者来自同一家公司，这个多签的实际安全性如何？可能存在什么风险？

---

## 答案

1. **对**。3/5 多签（3 of 5）意味着总共 5 个签名者，执行任何交易需要至少 3 个签名者的签名。

2. **C. 1/5**。1/5 多签意味着只需要 1 个签名就能执行交易，失去了多签的安全意义。任何一个签名者都能单独转走所有资金。

3. **1000 亿**（或「数百亿」）

4. **设计方案示例**：

   **配置**：4/7 多签

   **签名者**：
   - 核心团队：2 人（CEO、CTO）
   - 投资人：2 人（不同基金）
   - 顾问：2 人（外部独立人士）
   - 社区代表：1 人（选举产生）

   **理由**：
   - 7 人提供足够冗余，1-2 人失联不影响操作
   - 门槛 4/7（>50%）防止少数人控制
   - 核心团队只占 2/7，无法单独行动
   - 投资人和顾问来自不同组织，增加独立性
   - 社区代表保证社区利益

5. **分析**：

   **表面安全性**：4/7 看起来很安全

   **实际安全性**：大打折扣
   - 同一公司的 3 人可能共享访问权限
   - 可能使用同一办公网络，易被同时入侵
   - 公司内部可能协调一致
   - 实际「有效签名者」只有 4（1家公司算1个+其他4人）

   **风险**：
   - 该公司再说服 1 个外部签名者，就能控制资金
   - 公司内部被入侵，攻击者只需再获取 1 个私钥
   - 本质上更接近 2/4 的安全性（公司+1人即可）

   **建议**：同一组织最多提供 1 个签名者，保证真正的去中心化
