# DEX 与 AMM（去中心化交易所与自动做市商）

## 一句话大白话

**DEX 就是没有老板的自动售货机，你往里面投一种币，它自动吐出另一种币，价格由数学公式决定。**

---

## 它解决什么问题

### 传统交易所（CEX）的痛点

```
┌─────────────────────────────────────────────────────────────┐
│                   传统中心化交易所                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  你的钱 ──▶ [交给交易所] ──▶ 交易所账户                      │
│                  ↓                                          │
│            交易所说了算                                      │
│            ├── 可能跑路（FTX）                               │
│            ├── 可能冻结你的账户                              │
│            ├── 可能被黑客攻击                                │
│            └── 要求你做 KYC 身份验证                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### DEX 的解决方案

```
┌─────────────────────────────────────────────────────────────┐
│                   去中心化交易所                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  你的钱包 ──▶ [智能合约] ──▶ 直接返回你的钱包                 │
│                  ↓                                          │
│            代码说了算                                        │
│            ├── 代码开源，任何人可以审计                       │
│            ├── 资金始终在你自己钱包里                         │
│            ├── 无需身份验证                                  │
│            └── 7×24 小时运转，无人可以关停                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## AMM 的核心原理：恒定乘积公式

### 传统订单簿 vs AMM

```
传统订单簿模式：                     AMM 模式：

买单      卖单                      ┌─────────────┐
$100 ─┐ ┌─ $101                    │  流动性池   │
$99  ─┼─┼─ $102                    │             │
$98  ─┘ └─ $103                    │  ETH + USDC │
                                    │             │
需要有人挂单                         │  x × y = k │
价格由买卖双方决定                    └─────────────┘

                                    不需要对手方
                                    价格由公式决定
```

### 恒定乘积公式 x × y = k

**这是 Uniswap 的核心魔法，只需要记住一个公式：**

```
x × y = k（常数）

其中：
x = 池子里 A 代币的数量
y = 池子里 B 代币的数量
k = 恒定乘积（不变）
```

### 举个例子

假设池子里有：
- 10 ETH
- 10,000 USDC
- k = 10 × 10,000 = 100,000

**你想用 1,000 USDC 买 ETH：**

```
交易前：
x (ETH) = 10
y (USDC) = 10,000
k = 100,000

交易后：
y' (USDC) = 10,000 + 1,000 = 11,000
x' (ETH) = k / y' = 100,000 / 11,000 ≈ 9.09

你得到的 ETH = 10 - 9.09 = 0.91 ETH
实际价格 = 1,000 / 0.91 ≈ 1,099 USDC/ETH
```

**关键洞察**：
- 买的越多，价格越贵（滑点）
- 池子越大，滑点越小
- 价格由供需自动调节

### 价格曲线可视化

```
ETH 数量
    │
 20 │
    │                    ╭─────
 15 │               ╭────╯
    │          ╭────╯
 10 │─────╮────╯          x × y = 100,000
    │      ╰────╮
  5 │           ╰────╮
    │                ╰────╮
    └────┬────┬────┬────┬────▶ USDC 数量
         5k  10k  15k  20k

越往曲线两端，价格越极端
```

---

## 什么时候用 / 什么时候别用

### ✅ 适合用 DEX 的场景

| 场景 | 原因 |
|------|------|
| 小额交易（几百到几万美元） | 滑点可接受，Gas 费占比合理 |
| 交易长尾代币 | 很多小币只在 DEX 上有流动性 |
| 注重隐私 | 不需要 KYC |
| 担心交易所风险 | 资金始终在自己钱包 |
| 快速交易 | 无需充提，即连即用 |

### ❌ 不适合用 DEX 的场景

| 场景 | 原因 |
|------|------|
| 大额交易（几十万美元以上） | 滑点太大，损失可能超过 CEX 手续费 |
| 高频交易 | Gas 费太贵，不划算 |
| 法币出入金 | DEX 只支持加密货币之间的交易 |
| 网络拥堵时 | Gas 费可能高到离谱 |

---

## 它不是什么（常见混淆点）

### ❌ DEX 不是"完全没有中间人"

```
误解：DEX 完全去中心化，没有任何人控制

实际：
┌─────────────────────────────────────────┐
│  DEX 的中心化成分                        │
├─────────────────────────────────────────┤
│  • 前端网站可能被审查或下线               │
│  • 智能合约可能有管理员权限               │
│  • 代币列表由项目方决定                   │
│  • 路由算法由项目方设计                   │
└─────────────────────────────────────────┘

但是：
• 智能合约代码是开源的，可以直接交互
• 资金不托管在任何中心化实体
• 核心交易逻辑无法被人为干预
```

### ❌ AMM 不是"无滑点交易"

```
误解：AMM 能够以固定价格无限买卖

实际：
• 任何交易都会改变池子比例
• 交易越大，滑点越大
• 价格实时变化

这是 AMM 的特性，不是 bug
```

### ❌ DEX 价格不是"随便定的"

```
误解：DEX 价格由项目方操控

实际：
• 价格由 x × y = k 公式决定
• 套利者会让 DEX 价格与 CEX 保持一致
• 任何价格偏离都会被套利掉
```

---

## 最小例子：理解 AMM 定价

### 手算一笔交易

```python
# 初始状态
eth_in_pool = 100      # 池子里有 100 ETH
usdc_in_pool = 200000  # 池子里有 200,000 USDC
k = eth_in_pool * usdc_in_pool  # k = 20,000,000

# 当前价格
price = usdc_in_pool / eth_in_pool  # 2,000 USDC/ETH

# 你想用 10,000 USDC 买 ETH
usdc_to_spend = 10000

# 计算交易后状态
new_usdc = usdc_in_pool + usdc_to_spend  # 210,000
new_eth = k / new_usdc                    # 95.238

# 你得到的 ETH
eth_received = eth_in_pool - new_eth      # 4.762 ETH

# 实际成交价格
actual_price = usdc_to_spend / eth_received  # 2,100 USDC/ETH

# 滑点
slippage = (actual_price - price) / price   # 5%

print(f"理论价格: {price} USDC/ETH")
print(f"实际价格: {actual_price:.0f} USDC/ETH")
print(f"滑点: {slippage:.2%}")
print(f"获得: {eth_received:.3f} ETH")
```

输出：
```
理论价格: 2000 USDC/ETH
实际价格: 2100 USDC/ETH
滑点: 5.00%
获得: 4.762 ETH
```

---

## 新手最常踩的 3 个坑

### 坑 1：忽视滑点设置

```
场景：
你设置了 0.1% 的滑点容忍度
网络拥堵，交易 pending 了 10 分钟
这期间价格波动超过 0.1%
交易失败，但 Gas 费照扣

正确做法：
• 小额交易：设置 0.5% - 1% 滑点
• 波动剧烈时：设置 2% - 3% 滑点
• 稳定币交易：可以设低一点 0.1%
```

### 坑 2：不检查代币合约地址

```
场景：
你想买 XXX 代币
在 DEX 搜索框里搜到好几个同名代币
随便选了一个，结果是假币/钓鱼币
买完发现卖不出去（貔貅盘）

正确做法：
• 去官方渠道获取合约地址
• 在区块浏览器上验证合约
• 检查流动性大小
• 小额测试再大额操作
```

### 坑 3：Gas 费高峰期交易

```
场景：
你想做一笔 $100 的交易
当时 Gas 费 200 gwei
一笔 swap 花了 $50 Gas 费
手续费占比 50%，血亏

正确做法：
• 使用 Gas tracker 工具查看实时 Gas
• 非紧急交易选择低峰期（美国凌晨）
• 考虑使用 Layer2（Arbitrum、Optimism）
• 设置 Gas 价格上限
```

---

## 主流 DEX 对比

| DEX | 链 | 特点 | 适合场景 |
|-----|-----|------|---------|
| Uniswap | 以太坊/L2 | 最大流动性，龙头 | 主流币交易 |
| Curve | 以太坊/多链 | 稳定币专用，低滑点 | 稳定币兑换 |
| SushiSwap | 多链 | Uniswap fork，多链部署 | 跨链交易 |
| PancakeSwap | BSC | Gas 便宜 | 小额交易 |
| Raydium | Solana | 速度快，费用低 | 高频交易 |

---

## 流程图定位

```
┌─────────────────────────────────────────────────────────────┐
│                       DeFi 生态                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   你的钱包                                                   │
│      │                                                      │
│      ▼                                                      │
│   ╔═══════════════╗                                         │
│   ║  DEX (交易层) ║ ◀── 你在这里                             │
│   ╠═══════════════╣                                         │
│   ║  • Uniswap    ║                                         │
│   ║  • Curve      ║                                         │
│   ║  • SushiSwap  ║                                         │
│   ╚═══════════════╝                                         │
│          │                                                  │
│          ▼                                                  │
│   ┌─────────────────┐                                       │
│   │   流动性池       │ ← DEX 的核心引擎                       │
│   │   (下一章详解)   │                                       │
│   └─────────────────┘                                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 自测题

### 基础理解
1. 如果一个池子有 50 ETH 和 100,000 USDC，当前 ETH 价格是多少？
2. 为什么交易金额越大，滑点越大？
3. DEX 的价格是怎么和 CEX 保持一致的？

### 实践应用
4. 你想在 Uniswap 上用 500 USDC 买 ETH，应该注意哪些事项？
5. 如果你发现某个代币在 DEX 上的价格比 CEX 低 5%，意味着什么？

### 深度思考
6. 恒定乘积公式有什么缺陷？Curve 是怎么改进的？
7. 为什么 AMM 模式下做 LP 会有无常损失？（预习下一章）

---

## 答案提示

1. 100,000 / 50 = 2,000 USDC/ETH
2. 因为 x × y = k 是曲线，越往两端移动，价格变化越剧烈
3. 套利者：当价格偏离时，他们买低卖高赚差价，同时把价格拉平
4. 检查滑点设置、确认代币合约地址、查看 Gas 费、小额测试
5. 可能是套利机会，也可能是流动性不足或假币，需要谨慎验证
6. 恒定乘积对稳定币交易效率低；Curve 使用专门的稳定币曲线，在接近 1:1 时更平滑
7. 详见下一章！
