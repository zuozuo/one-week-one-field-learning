# Layer 2 - 二层扩展方案

## 一句话大白话

**Layer 2 就是在主链旁边修的「高速公路」——主链太堵太贵，先在高速路上跑，最后再跟主链结算。**

想象以太坊是一条市中心的主干道，每天堵得要命，过路费（Gas）贵得离谱。Layer 2 就是在旁边修的高架桥/隧道，让你先在上面快速便宜地开，最后在入口/出口和主干道结算一下就行。

---

## 它解决什么问题

### 以太坊主网的问题

| 问题 | 数据 |
|------|------|
| 速度慢 | ~15-30 TPS (每秒交易数) |
| 费用高 | 一笔简单转账可能 $1-50 |
| 拥堵时更糟 | NFT 热卖时 Gas 可达几百美元 |

对比：VISA 处理 ~24,000 TPS，手续费几毛钱

### Layer 2 的解决方案

| 改进 | 效果 |
|------|------|
| 提高吞吐量 | 可达 2,000-4,000+ TPS |
| 降低费用 | 通常是主网的 1/10 到 1/100 |
| 保持安全 | 最终安全性由主网保障 |

---

## 什么时候用 / 什么时候别用

### 适合用 Layer 2 的场景

| 场景 | 说明 |
|------|------|
| 高频小额交易 | 手续费占比太高的情况 |
| 游戏/社交应用 | 需要即时响应 |
| 日常 DeFi 操作 | Swap、借贷等频繁操作 |

### 需要注意的情况

| 情况 | 说明 |
|------|------|
| 大额长期存储 | 主网更「经过验证」|
| 需要即时最终性 | L2 提款可能需要等待 |
| 流动性要求高 | 有些资产在 L2 流动性不足 |

### 判断口诀
> 小额高频上 L2，大额长存留主网，注意桥接风险

---

## 它不是什么

### 常见误解

| 误解 | 事实 |
|------|------|
| L2 是另一条链 | 是以太坊的扩展，安全性依赖主网 |
| L2 完全继承主网安全 | 不同 L2 安全假设不同 |
| 资产可以直接用 | 需要先「桥接」过去 |
| L2 都一样 | 不同技术路线差异很大 |

---

## 最小例子

### Layer 2 技术分类

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Layer 2 扩展方案分类                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    Rollups (主流方案)                        │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │  ┌─────────────────────┐   ┌─────────────────────────────┐ │   │
│  │  │  Optimistic Rollup  │   │   ZK Rollup (零知识证明)    │ │   │
│  │  │                     │   │                             │ │   │
│  │  │  "先相信，后验证"   │   │   "用数学证明正确性"        │ │   │
│  │  │                     │   │                             │ │   │
│  │  │  - Optimism         │   │   - zkSync                  │ │   │
│  │  │  - Arbitrum         │   │   - StarkNet                │ │   │
│  │  │  - Base             │   │   - Polygon zkEVM           │ │   │
│  │  │                     │   │                             │ │   │
│  │  │  提款等待: 7 天     │   │   提款等待: 几分钟-几小时   │ │   │
│  │  └─────────────────────┘   └─────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │               其他方案 (应用场景更窄)                        │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │  ┌─────────────────────┐   ┌─────────────────────────────┐ │   │
│  │  │  State Channels     │   │   Plasma                    │ │   │
│  │  │  状态通道            │   │                             │ │   │
│  │  │                     │   │   几乎被 Rollup 淘汰        │ │   │
│  │  │  - 闪电网络 (BTC)   │   │                             │ │   │
│  │  └─────────────────────┘   └─────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Optimistic Rollup 原理

```
核心思想: 乐观假设 + 欺诈证明

┌─────────────────────────────────────────────────────────────────────┐
│                        Optimistic Rollup 工作流程                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. 交易在 L2 执行                                                  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 用户在 L2 发送交易                                           │   │
│  │ → L2 排序器 (Sequencer) 收集交易                            │   │
│  │ → 执行交易，更新 L2 状态                                     │   │
│  │ → 用户几秒内就看到确认                                       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                           │                                         │
│                           ▼                                         │
│  2. 压缩后提交到 L1                                                 │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 排序器把一批交易压缩                                          │   │
│  │ → 只提交交易数据 (calldata) 到 L1                            │   │
│  │ → 不提交执行结果                                              │   │
│  │ → 乐观假设: 结果是正确的                                      │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                           │                                         │
│                           ▼                                         │
│  3. 挑战期 (Challenge Period)                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 7 天等待期                                                    │   │
│  │ → 任何人可以验证交易执行是否正确                              │   │
│  │ → 如果发现错误，提交「欺诈证明」                              │   │
│  │ → 证明成功 → 回滚错误交易，惩罚作恶者                        │   │
│  │ → 7 天无挑战 → 交易最终确认                                  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

为什么要 7 天？
- 给足够时间让任何人验证和挑战
- 假设至少有一个诚实的验证者在监控
- 这是安全性的代价
```

### ZK Rollup 原理

```
核心思想: 用密码学证明正确性

┌─────────────────────────────────────────────────────────────────────┐
│                        ZK Rollup 工作流程                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. 交易在 L2 执行                                                  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 用户发送交易到 L2                                            │   │
│  │ → 排序器执行交易                                              │   │
│  │ → 计算新状态                                                  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                           │                                         │
│                           ▼                                         │
│  2. 生成零知识证明                                                  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 证明器 (Prover) 生成 ZK-SNARK/STARK 证明                     │   │
│  │ → 这个证明很小 (几百字节)                                    │   │
│  │ → 但能证明成千上万笔交易的执行是正确的                        │   │
│  │ → 计算密集，需要强大硬件                                      │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                           │                                         │
│                           ▼                                         │
│  3. 提交证明到 L1                                                   │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 提交: 状态根 + ZK 证明 到 L1                                  │   │
│  │ → L1 合约验证证明 (便宜)                                      │   │
│  │ → 验证通过 → 立即最终确认                                     │   │
│  │ → 不需要等待期                                                │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

ZK 证明的神奇之处:
- 我可以证明「我知道答案」但不告诉你答案是什么
- 证明很小但验证很便宜
- 数学保证正确性，不需要信任任何人
```

### Optimistic vs ZK 对比

```
┌─────────────────────┬─────────────────────────┬─────────────────────────┐
│        特性         │    Optimistic Rollup    │       ZK Rollup        │
├─────────────────────┼─────────────────────────┼─────────────────────────┤
│ 安全假设            │ 至少 1 个诚实验证者     │ 纯数学，无需信任        │
├─────────────────────┼─────────────────────────┼─────────────────────────┤
│ 提款时间            │ 7 天                    │ 几分钟到几小时          │
├─────────────────────┼─────────────────────────┼─────────────────────────┤
│ 计算成本            │ L2 便宜                │ 证明生成贵              │
├─────────────────────┼─────────────────────────┼─────────────────────────┤
│ EVM 兼容性          │ 好 (容易兼容)          │ 难 (但在改进)           │
├─────────────────────┼─────────────────────────┼─────────────────────────┤
│ 成熟度              │ 更成熟                  │ 快速发展中              │
├─────────────────────┼─────────────────────────┼─────────────────────────┤
│ 代表项目            │ Arbitrum, Optimism      │ zkSync, StarkNet        │
└─────────────────────┴─────────────────────────┴─────────────────────────┘

选择建议:
- 现在: Optimistic Rollup 生态更完善
- 未来: ZK Rollup 被认为是「终极方案」
- 两者会长期共存
```

### 使用 Layer 2 的流程

```
从主网到 L2:

┌─────────────────────────────────────────────────────────────────────┐
│                        桥接流程 (Deposit)                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  以太坊主网 (L1)                      Layer 2                       │
│  ┌─────────────┐                    ┌─────────────┐                │
│  │ 你的钱包    │                    │ L2 上的    │                │
│  │ 1 ETH      │                    │ 你的钱包    │                │
│  └─────────────┘                    └─────────────┘                │
│        │                                   ▲                        │
│        │ 1. 发送 ETH 到桥合约               │                        │
│        ▼                                   │                        │
│  ┌─────────────┐                          │                        │
│  │ 官方桥合约  │ ─── 2. L2 铸造等量代币 ───┘                        │
│  │ (锁定 ETH) │                                                    │
│  └─────────────┘                                                    │
│                                                                     │
│  时间: 几分钟                                                        │
│  费用: L1 Gas 费                                                    │
└─────────────────────────────────────────────────────────────────────┘

从 L2 回主网:

┌─────────────────────────────────────────────────────────────────────┐
│                        提款流程 (Withdrawal)                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Optimistic Rollup:                                                 │
│  1. 发起提款请求                                                     │
│  2. 等待 7 天挑战期                                                  │
│  3. 挑战期结束后领取                                                 │
│                                                                     │
│  ZK Rollup:                                                         │
│  1. 发起提款请求                                                     │
│  2. 等待证明生成和验证 (几分钟-几小时)                               │
│  3. 领取                                                            │
│                                                                     │
│  快速提款服务:                                                       │
│  - 第三方流动性提供者                                                │
│  - 你付手续费，他们垫资                                              │
│  - 不用等 7 天                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 新手最常踩的 3 个坑

### 1. 不知道资产在哪条链

**坑**：以为主网和 L2 资产互通。

**后果**：
```
你在主网有 1 ETH
→ 想在 Arbitrum 上用
→ 直接操作，发现余额是 0
→ 忘了要先桥接过去
```

**正解**：
- 时刻注意钱包连接的网络
- 资产需要先桥接才能在不同网络使用
- 不同 L2 之间也不互通

### 2. 使用不安全的桥

**坑**：随便用一个号称更快的第三方桥。

**风险**：
- 桥合约被黑是最大的安全风险之一
- 2022 年多个桥被黑，损失数亿美元
- 第三方桥可能有后门

**正解**：
- 优先使用官方桥
- 如果用第三方，选择知名、经过审计的
- 大额谨慎

### 3. 忽视提款等待时间

**坑**：急着用钱，发现要等 7 天。

**场景**：
```
你在 Arbitrum 上有 10 ETH
→ 主网有紧急用途
→ 发起提款
→ 发现要等 7 天
→ 错过机会
```

**正解**：
- 了解不同 L2 的提款时间
- 预留足够时间
- 急用可以用快速提款服务（但要付手续费）

---

## 流程图定位

```
Layer 2 在整个 Web3 架构中的位置:

┌─────────────────────────────────────────────────────────────────────┐
│                         用户交互层                                   │
│                    钱包、DApp 前端                                   │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        Layer 2 (扩展层)                              │
│              Arbitrum / Optimism / zkSync / ...                     │
│                    快速、便宜、高吞吐                                │
└─────────────────────────────────────────────────────────────────────┘
                              │ 定期结算/证明
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Layer 1 (以太坊主网)                            │
│                     安全、去中心化、最终性                           │
└─────────────────────────────────────────────────────────────────────┘

L2 的角色:
- 承担日常交易的执行
- 把执行结果压缩后提交到 L1
- 继承 L1 的安全性
```

---

## 自测题

1. **为什么 Optimistic Rollup 提款要等 7 天，但 ZK Rollup 不用？**

   <details>
   <summary>点击查看答案</summary>
   Optimistic Rollup:
   - 「乐观」假设交易是正确的
   - 需要时间让任何人来验证和挑战
   - 7 天是给验证者发现问题的窗口

   ZK Rollup:
   - 每批交易都附带数学证明
   - L1 合约验证证明通过就确定是正确的
   - 不需要等待，数学已经保证了正确性
   </details>

2. **Layer 2 便宜，为什么不把所有东西都放 L2？**

   <details>
   <summary>点击查看答案</summary>
   考虑因素：
   1. 安全性：L1 更「经过时间检验」，L2 相对较新
   2. 流动性：很多资产在 L1 流动性更好
   3. 复杂性：需要桥接，增加操作步骤和风险
   4. 退出问题：大额提款可能要等待
   5. 生态：有些 DApp/协议只在 L1

   建议：根据用途选择，不是非黑即白
   </details>

3. **如果 L2 的排序器（Sequencer）作恶或宕机会怎样？**

   <details>
   <summary>点击查看答案</summary>
   排序器作恶：
   - 可以审查交易（不打包你的交易）
   - 可以重排序交易（MEV 提取）
   - 不能偷你的钱（因为 L1 是最终仲裁）

   排序器宕机：
   - L2 暂时停摆
   - 但你可以强制通过 L1 提交交易
   - 最终可以提走资产（虽然可能要等）

   解决方案（在推进中）：
   - 去中心化排序器
   - 强制包含机制
   - 基于 L1 的排序
   </details>
