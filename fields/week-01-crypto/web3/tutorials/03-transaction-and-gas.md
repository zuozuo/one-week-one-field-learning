# 交易与 Gas (Transaction & Gas)

## 一句话大白话

**Gas 就是区块链上的「油费」——你想让区块链帮你干活，就得付油费。**

就像开车要加油，用区块链也要付费。不同操作耗油不同：简单转账像市区开车，复杂的智能合约像上高速狂飙。油费不固定，堵车（网络拥堵）时贵，闲时便宜。

---

## 它解决什么问题

### 问题 1：防止垃圾交易

如果交易免费，攻击者可以发送海量垃圾交易让网络瘫痪。Gas 费用让攻击变得昂贵。

### 问题 2：激励矿工/验证者

矿工/验证者需要消耗计算资源来处理交易。Gas 费是他们的报酬，激励他们维护网络。

### 问题 3：分配稀缺资源

区块空间有限（每个区块能装的交易数量有限）。Gas 机制让愿意付更多钱的交易优先被处理。

---

## 什么时候用 / 什么时候别用

### Gas 费的影响因素

| 因素 | 说明 |
|------|------|
| 网络拥堵程度 | 越堵越贵，大家抢着付高价 |
| 操作复杂度 | 简单转账便宜，复杂合约贵 |
| 数据大小 | 交易数据越多越贵 |
| 时间紧迫性 | 想快点确认就多付点 |

### 省 Gas 的技巧

| 技巧 | 说明 |
|------|------|
| 选择低峰时段 | 周末、亚洲凌晨通常便宜 |
| 使用 Layer 2 | Arbitrum、Optimism 等便宜很多 |
| 批量操作 | 多个操作合并成一笔交易 |
| 设置合理的 Gas 上限 | 不要盲目设太高 |

### 判断口诀
> 急事多付快，闲事慢慢来，大额上 L2，小额等低谷

---

## 它不是什么

### 常见误解

| 误解 | 事实 |
|------|------|
| Gas 费交给了以太坊公司 | 以太坊没有公司，Gas 费交给验证者，部分被销毁 |
| 交易失败不扣 Gas | 失败也要扣 Gas（因为计算资源已经消耗了） |
| Gas 价格固定 | 完全根据市场供需浮动 |
| Gas 和代币是一回事 | Gas 是计量单位，Gas Price（以 Gwei 计）× Gas Used = 实际费用（以 ETH 计） |

---

## 最小例子

### 理解 Gas 的计算

```
一笔交易的费用计算：

┌─────────────────────────────────────────────────────────┐
│                                                         │
│   总费用 = Gas Used × Gas Price                         │
│                                                         │
│   Gas Used: 这笔交易实际消耗了多少「油」                  │
│   Gas Price: 每单位「油」的价格（单位：Gwei）             │
│                                                         │
│   1 Gwei = 0.000000001 ETH = 10^-9 ETH                  │
│                                                         │
└─────────────────────────────────────────────────────────┘

举例：

简单 ETH 转账：
├── Gas Used: 21,000 (固定值)
├── Gas Price: 30 Gwei
└── 总费用: 21,000 × 30 Gwei = 630,000 Gwei = 0.00063 ETH ≈ $1.5

ERC-20 代币转账：
├── Gas Used: ~65,000
├── Gas Price: 30 Gwei
└── 总费用: 65,000 × 30 Gwei = 1,950,000 Gwei = 0.00195 ETH ≈ $4.7

复杂 DeFi 操作：
├── Gas Used: ~200,000
├── Gas Price: 30 Gwei
└── 总费用: 200,000 × 30 Gwei = 6,000,000 Gwei = 0.006 ETH ≈ $14.4

(假设 ETH = $2400)
```

### EIP-1559 新 Gas 机制

```
传统模式 (拍卖制):
┌─────────────────────────────────────────────────────────┐
│ 你出价: 50 Gwei                                         │
│ 别人出价: 60, 70, 80 Gwei                               │
│ 结果: 出价高的先被处理，你可能等很久                      │
│ 问题: 难以预测该出多少价                                 │
└─────────────────────────────────────────────────────────┘

EIP-1559 模式 (基础费 + 小费):
┌─────────────────────────────────────────────────────────┐
│                                                         │
│   总费用 = Base Fee + Priority Fee (Tip)                │
│                                                         │
│   Base Fee (基础费):                                     │
│   ├── 由网络自动计算                                     │
│   ├── 根据上一个区块的使用率动态调整                      │
│   └── 这部分费用被销毁（不给验证者）                      │
│                                                         │
│   Priority Fee (小费/优先费):                            │
│   ├── 你自己决定给多少                                   │
│   ├── 小费越高，越快被处理                               │
│   └── 这部分给验证者                                     │
│                                                         │
│   Max Fee (最高费用):                                    │
│   ├── 你愿意支付的最高价格                               │
│   └── 实际费用 = Base Fee + Priority Fee（不超过 Max）   │
│                                                         │
└─────────────────────────────────────────────────────────┘

举例:
你设置: Max Fee = 50 Gwei, Priority Fee = 2 Gwei
当前 Base Fee = 30 Gwei

实际支付: 30 (Base) + 2 (Tip) = 32 Gwei
退还: 50 - 32 = 18 Gwei
```

### 交易结构详解

```javascript
// 一笔以太坊交易的完整结构
const transaction = {
  // 必填字段
  to: "0x接收方地址",        // 接收方
  value: "1000000000000000000",  // 转账金额（单位：Wei，这是 1 ETH）

  // Gas 相关
  gasLimit: 21000,           // Gas 上限（最多消耗这么多）
  maxFeePerGas: 50e9,        // 最高 Gas 价格（50 Gwei）
  maxPriorityFeePerGas: 2e9, // 小费（2 Gwei）

  // 其他
  nonce: 0,                  // 发送方的交易计数（防重放）
  chainId: 1,                // 链 ID（1 = 主网，防止跨链重放）
  data: "0x",                // 附带数据（调用合约时填函数调用数据）
};

// 单位换算
// 1 ETH = 10^18 Wei
// 1 Gwei = 10^9 Wei
// 所以 1 ETH = 10^9 Gwei
```

### 交易状态流转

```
发起交易
    │
    ▼
┌─────────────┐
│  Pending    │  在内存池等待
│  (待处理)    │  可能被加速或取消
└─────────────┘
    │
    │ 被矿工/验证者选中
    ▼
┌─────────────┐
│  Confirmed  │  被打包进区块
│  (已确认)    │  等待更多确认
└─────────────┘
    │
    │ 后续区块继续产生
    ▼
┌─────────────┐
│  Finalized  │  有足够多的后续区块
│  (已最终化)  │  基本不可逆转
└─────────────┘

异常情况:
┌─────────────┐
│  Failed     │  执行失败（如合约报错）
│  (失败)      │  Gas 已消耗，但操作没完成
└─────────────┘

┌─────────────┐
│  Dropped    │  Gas 价格太低，被踢出内存池
│  (丢弃)      │  需要重新发送
└─────────────┘
```

---

## 新手最常踩的 3 个坑

### 1. Gas Limit 设太低导致交易失败

**坑**：为了省钱把 Gas Limit 设得很低。

**后果**：
- 交易执行到一半 Gas 用完
- 交易失败，但 Gas 费照扣（因为计算已经消耗了）
- 白白损失 Gas 费，事情还没办成

**正解**：
- 使用钱包推荐的 Gas Limit
- 复杂操作留足够余量
- Gas Limit 是「上限」，用不完会退还

### 2. 交易卡住后重复发送

**坑**：交易 Pending 太久，以为没发成功，又发了几笔。

**后果**：
- 所有交易都在排队
- 第一笔确认后，后面的可能也会执行（如果 nonce 递增）
- 或者后面的全失败（如果 nonce 相同但 Gas 不够覆盖）

**正解**：
- 同一笔交易可以用「加速」功能（提高 Gas Price，保持 nonce 不变）
- 或者「取消」（发一笔 nonce 相同、金额为 0 的交易给自己）
- 不要盲目重新发送

### 3. 不看 Gas 价格就操作

**坑**：NFT 热卖或市场剧烈波动时急着操作。

**后果**：
- Gas 费可能是平时的 10-100 倍
- 一笔操作花掉几百美元 Gas 费
- 事后发现等等就好了

**正解**：
- 操作前看一眼 Gas 价格（用 etherscan.io/gastracker）
- 非紧急操作等低峰期
- 大额操作考虑用 Layer 2

---

## 流程图定位

```
┌──────┐    ┌──────────┐    ┌────────┐    ┌──────────┐    ┌────────────┐
│ 用户 │───▶│ 创建钱包 │───▶│ 签名   │───▶│ ★广播   │───▶│ ★矿工    │
│ 意图 │    │ (私钥)   │    │ 交易   │    │  交易★  │    │  打包★    │
└──────┘    └──────────┘    └────────┘    └──────────┘    └────────────┘

交易和 Gas 主要涉及两个阶段：
1. 「广播交易」：设置 Gas 参数，发送到网络
2. 「矿工打包」：根据 Gas Price 决定处理优先级

Gas 费的作用：
- 对用户：决定交易被处理的速度
- 对矿工：作为处理交易的报酬
- 对网络：防止垃圾交易，分配稀缺的区块空间
```

---

## 自测题

1. **一笔交易的 Gas Limit 设为 100,000，实际只用了 21,000，会怎样？**

   <details>
   <summary>点击查看答案</summary>
   只会扣除 21,000 × Gas Price 的费用，剩余的 79,000 Gas 会退还。Gas Limit 只是上限，不是实际消费。
   </details>

2. **为什么交易失败了还要扣 Gas 费？**

   <details>
   <summary>点击查看答案</summary>
   因为验证者已经执行了交易的计算过程（虽然最终失败了），计算资源已经消耗。Gas 费是为计算付费，不是为结果付费。这也防止了攻击者发送大量会失败的复杂交易来免费消耗网络资源。
   </details>

3. **EIP-1559 之后，为什么说 ETH 变得更「稀缺」了？**

   <details>
   <summary>点击查看答案</summary>
   因为 Base Fee 会被销毁（burn），不是给验证者。每笔交易都在销毁 ETH。如果网络使用率高，销毁的 ETH 可能超过新发行的 ETH，导致 ETH 总量减少（通缩）。这就是所谓的「超声波货币」(Ultrasound Money) 叙事。
   </details>
