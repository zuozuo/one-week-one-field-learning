# 智能合约 (Smart Contract)

## 一句话大白话

**智能合约就是"自动执行的电子合同"——条件满足就自动办事，没有中间商，不能反悔。**

就像自动售货机：投币 → 选商品 → 出货，整个过程不需要人工，规则写死在机器里。智能合约就是区块链上的"自动售货机"。

---

## 它解决什么问题

### 核心痛点：合同执行依赖信任

传统合同的问题：
- 需要信任对方会履约
- 需要第三方（法院、仲裁）来保证执行
- 执行成本高、速度慢
- 存在毁约、赖账的可能

### 智能合约的解决方案

```
传统合同：
张三承诺："如果李四付款，我就发货"
→ 李四付款了
→ 张三可能反悔
→ 李四要找律师打官司
→ 耗时数月，花费数万

智能合约：
合约代码："如果收到李四的钱，自动把NFT转给李四"
→ 李四付款
→ 代码自动执行转移
→ 毫秒完成，无法反悔
```

### 在 NFT 场景中的作用

| 功能 | 智能合约做了什么 |
|------|-----------------|
| 铸造 NFT | 创建新的 TokenID，分配给铸造者 |
| 转账 NFT | 更新所有权记录（owner 字段） |
| 交易 NFT | 收款后自动转移 NFT |
| 版税分成 | 每次转卖自动给创作者分钱 |
| 白名单铸造 | 检查地址是否在白名单中 |

---

## 什么时候用 / 什么时候别用

### ✅ 适合用智能合约的场景

- 规则明确、可用代码表达
- 需要自动执行、无需人工干预
- 涉及资产转移（代币、NFT）
- 多方协作但互不信任

### ❌ 不适合用智能合约的场景

- 规则模糊、需要人工判断
- 需要连接链下数据（需配合预言机）
- 需要频繁修改逻辑（合约一旦部署难以修改）
- 涉及隐私数据（合约代码和数据都公开）

---

## 它不是什么（常见混淆点）

### ❌ 智能合约 ≠ 法律合同

智能合约是代码，不是法律文件。
- 法律合同可以被法院解释、修改、撤销
- 智能合约按代码执行，"代码即法律"

### ❌ 智能合约 ≠ 智能（AI）

名字里有"智能"，但跟 AI 没关系：
- 不会学习、不会判断
- 只是"条件判断 + 自动执行"
- 更像"确定性程序"

### ❌ 智能合约 ≠ 绝对安全

智能合约可能有漏洞：
- 代码 bug（历史上多次大额被盗）
- 逻辑漏洞（重入攻击等）
- 一旦部署，漏洞也被锁死

---

## 最小例子

### 一个最简单的 NFT 合约（伪代码）

```solidity
contract SimpleNFT {
    // 记录每个 TokenID 的所有者
    mapping(uint256 => address) public owners;

    // 铸造 NFT
    function mint(uint256 tokenId) public {
        require(owners[tokenId] == address(0), "已存在");
        owners[tokenId] = msg.sender;  // 谁调用就给谁
    }

    // 转移 NFT
    function transfer(uint256 tokenId, address to) public {
        require(owners[tokenId] == msg.sender, "你不是所有者");
        owners[tokenId] = to;
    }
}
```

### 智能合约执行流程

```
用户                      钱包                     智能合约
 │                         │                          │
 │  1. 点击"铸造"按钮      │                          │
 │────────────────────────▶│                          │
 │                         │                          │
 │  2. 钱包弹窗确认        │                          │
 │◀────────────────────────│                          │
 │                         │                          │
 │  3. 用户确认 + 支付Gas  │                          │
 │────────────────────────▶│                          │
 │                         │                          │
 │                         │  4. 调用 mint 函数       │
 │                         │─────────────────────────▶│
 │                         │                          │
 │                         │                          │  5. 合约执行
 │                         │                          │  - 检查是否已存在
 │                         │                          │  - 记录所有者
 │                         │                          │
 │                         │  6. 返回成功             │
 │                         │◀─────────────────────────│
 │                         │                          │
 │  7. 显示：铸造成功！     │                          │
 │◀────────────────────────│                          │
```

### 真实 NFT 合约长什么样

OpenSea 上看一个 NFT 的合约信息：
- Contract Address: `0x1234...5678`
- Token Standard: ERC-721
- 可以点进去看合约源代码

---

## 新手最常踩的 3 个坑

### 1. 以为可以撤回或修改

**坑**：铸造错了想撤回，找客服要求修改

**真相**：
- 智能合约一旦执行，无法撤回
- 没有"客服"可以帮你改链上数据
- "代码即法律"——代码怎么写，就怎么执行

**建议**：操作前仔细确认，小额测试

### 2. 盲目信任"智能"二字

**坑**：以为智能合约自动就是安全的

**真相**：
- 智能合约可能有 bug
- 可能被黑客利用漏洞
- 历史上亿级美元被盗案例很多

**建议**：
- 只和知名、审计过的合约交互
- 不要授权不了解的合约
- 注意 approve（授权）的额度

### 3. 不理解 Gas 失败

**坑**：交易失败了，Gas 费没了

**真相**：
- Gas 是付给矿工的"手续费"
- 即使合约执行失败，Gas 也不退
- 失败原因可能是：余额不足、条件不满足、Gas 设太低

**建议**：
- 确保账户有足够的 ETH
- 了解合约的执行条件
- 不确定时先在测试网试

---

## 流程图定位

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  准备阶段  │───▶│  创作阶段  │───▶│  铸造阶段  │───▶│  交易阶段  │───▶│  持有阶段  │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
                                     │               │
                                     ▼               ▼
                              【调用智能合约】   【调用智能合约】
                               mint() 函数      transfer() 函数
                               创建 NFT        转移所有权
```

智能合约是 NFT 操作的"执行者"：
- **铸造**：调用合约的 mint 函数
- **转账**：调用合约的 transfer 函数
- **交易**：调用合约的交易函数（或通过市场合约）
- **版税**：合约自动计算并分配

---

## 自测题

1. **概念理解**：为什么智能合约被称为"自动执行"？它和传统合同有什么本质区别？

2. **场景判断**：以下哪种情况智能合约能处理？
   - A. "如果天气好，活动照常举行"
   - B. "如果收到 0.1 ETH，转移 NFT"
   - C. "如果作品质量好，支付报酬"
   - D. "如果比赛结果公平，分配奖金"

3. **安全意识**：你在一个新网站上看到"授权合约"的请求，应该注意什么？

<details>
<summary>参考答案</summary>

1. 智能合约是代码，部署在区块链上。一旦条件满足（如收到付款），代码自动执行（如转移资产），不需要人工干预，也无法人为阻止。传统合同需要人来执行，可能毁约、可能打官司；智能合约是机器执行，条件满足必然执行，无法反悔。

2. 答案是 B。智能合约只能处理链上的、可明确验证的条件。A、C、D 都需要人工判断（天气好坏、质量好坏、是否公平），智能合约无法判断。B 是明确的链上条件：收到 0.1 ETH 这件事可以被代码准确检测。

3. 应该注意：
   - 这是什么合约？是否来自可信来源？
   - 授权的是什么操作？（查看合约地址、搜索是否有安全报告）
   - 授权的额度是多少？（无限授权风险最高）
   - 网站是否正规？（钓鱼网站常用假授权骗取资产）
   - 不确定就不要授权

</details>
