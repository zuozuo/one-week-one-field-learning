# IPFS (InterPlanetary File System)

## 一句话大白话

**IPFS 是去中心化的"网盘"——文件分散存储在全球各地，不怕单点故障，靠内容本身来定位文件。**

传统网址是"告诉你去哪里找"（地址寻址），IPFS 是"告诉你要找什么"（内容寻址）。

---

## 它解决什么问题

### 核心痛点：中心化存储的问题

传统 HTTP 存储：
```
https://server.com/images/cat.jpg
       │
       └── 依赖 server.com 这台服务器
           - 服务器宕机 → 图片没了
           - 服务器被墙 → 访问不了
           - 文件被删除 → 永久丢失
           - 文件被替换 → 你不知道
```

### IPFS 的解决方案

```
ipfs://QmXjkFQjnD8i8ntmwehoAHBfJEApETx8ebScyoBbJCE
      │
      └── 这是文件内容的"指纹"（哈希值）
          - 任何节点都可以提供这个文件
          - 内容变了，指纹就变，链接就失效
          - 只要有人保存，文件就存在
```

### 为什么 NFT 需要 IPFS

| 存储方式 | 问题 | IPFS 的优势 |
|---------|------|------------|
| 项目方服务器 | 项目跑路文件就没了 | 去中心化，不依赖单一方 |
| 传统云存储 | 可以被审查、删除 | 抗审查 |
| 链上存储 | 太贵 | 便宜（或免费） |
| 任何可修改的存储 | 图片可能被替换 | 内容变=链接变，不可篡改 |

---

## 什么时候用 / 什么时候别用

### ✅ 适合用 IPFS 的场景

- NFT 图片和元数据存储
- 需要内容不可篡改的场景
- 需要去中心化、抗审查
- 需要内容可验证性

### ❌ 不适合用 IPFS 的场景

- 需要频繁修改的内容
- 动态生成的内容
- 私密内容（IPFS 内容公开）
- 需要稳定高速访问的商业应用

---

## 它不是什么（常见混淆点）

### ❌ IPFS ≠ 永久存储

**最大误区！**

IPFS 只是一个协议，不保证永久存储：
- 如果没有节点保存（pin）你的文件，文件会从网络中消失
- 需要有人持续"钉住"（pin）文件
- 没有 pin 的文件可能在几周后就找不到了

### ❌ IPFS ≠ 区块链

| 特性 | IPFS | 区块链 |
|------|------|--------|
| 本质 | 文件存储/分享协议 | 分布式账本 |
| 存什么 | 任意文件 | 交易记录 |
| 持久性 | 需要有人 pin | 永久（只要链存在） |
| 成本 | 存储免费，pin 可能收费 | 每次写入都收费 |

### ❌ CID ≠ 可以反推出文件内容

CID（Content Identifier）是文件的哈希值：
- 可以验证：给你文件，你能算出是不是这个 CID
- 不能反推：给你 CID，你算不出文件内容

---

## 最小例子

### IPFS 链接格式

```
原生格式：
ipfs://QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG

通过网关访问：
https://ipfs.io/ipfs/QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG
https://gateway.pinata.cloud/ipfs/QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG
https://cloudflare-ipfs.com/ipfs/QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG
```

### CID 是怎么来的

```
文件内容: "Hello, IPFS!"
    │
    ▼ 哈希算法
    │
CID: QmWATWQ7fVPP2EFGu71UkfnqhYXDYH566qy47CnJDgvs8u
    │
    ▼
- 内容变一个字，CID 完全不同
- 相同内容，CID 永远相同
```

### 在 NFT 中的应用

```
元数据（metadata.json）：
{
  "name": "Cool NFT",
  "image": "ipfs://QmImageHash..."  ← 图片存在 IPFS
}
    │
    ▼ 上传到 IPFS
    │
元数据的 CID: QmMetadataHash...
    │
    ▼ 写入智能合约
    │
tokenURI: "ipfs://QmMetadataHash..."
```

### 工作流程

```
创作者                     IPFS 网络                    收藏者
   │                          │                          │
   │  1. 上传图片              │                          │
   │─────────────────────────▶│                          │
   │  返回 CID                 │                          │
   │◀─────────────────────────│                          │
   │                          │                          │
   │  2. Pin 这个文件          │                          │
   │─────────────────────────▶│                          │
   │                          │                          │
   │          ...时间流逝...   │                          │
   │                          │                          │
   │                          │  3. 请求这个 CID          │
   │                          │◀─────────────────────────│
   │                          │  返回文件内容             │
   │                          │─────────────────────────▶│
```

---

## 新手最常踩的 3 个坑

### 1. 以为 IPFS = 永久保存

**坑**：上传到 IPFS 就高枕无忧了

**真相**：
- 没人 pin → 文件消失
- 免费 pin 服务可能停止服务
- 只有持续付费 pin 才相对可靠

**正确做法**：
- 使用 Pinata、Infura 等 pin 服务
- 重要文件自己跑节点 pin
- 高价值 NFT 考虑多重备份

### 2. 混淆 IPFS 链接和网关链接

**坑**：分不清 `ipfs://` 和 `https://ipfs.io/ipfs/`

**解释**：
```
ipfs://QmXxx...        ← 原生 IPFS 链接，需要 IPFS 客户端
https://ipfs.io/ipfs/QmXxx...  ← 通过 HTTP 网关访问

元数据中应该存原生链接 ipfs://
显示时可以转换成网关链接
```

**风险**：如果元数据中存的是网关链接（如 `https://ipfs.io/...`），那个网关挂了就访问不了

### 3. 不理解内容寻址的含义

**坑**：以为可以"更新" IPFS 上的文件

**真相**：
- 修改内容 → CID 改变 → 变成新文件
- 原来的 CID 永远指向原来的内容
- 想要"更新"只能重新上传新文件

---

## 流程图定位

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  准备阶段  │───▶│  创作阶段  │───▶│  铸造阶段  │───▶│  交易阶段  │───▶│  持有阶段  │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
                                     │
                                     ▼
                              【上传到 IPFS】
                              - 图片 → 获得 CID
                              - 元数据 → 获得 CID
                              - 元数据 CID 写入合约
```

IPFS 主要在铸造阶段使用：
- 上传图片文件到 IPFS
- 上传元数据文件到 IPFS
- 将元数据的 IPFS 链接写入智能合约

---

## 常用 IPFS 工具和服务

### Pin 服务

| 服务 | 免费额度 | 特点 |
|------|---------|------|
| Pinata | 1GB | 最流行，API 友好 |
| Infura | 5GB | 大厂背书 |
| nft.storage | 无限 | 专为 NFT 设计，完全免费 |
| Web3.Storage | 无限 | Filecoin 支持 |

### 网关

```
公共网关（免费但可能慢/不稳定）：
- https://ipfs.io/ipfs/
- https://cloudflare-ipfs.com/ipfs/
- https://gateway.pinata.cloud/ipfs/

专用网关（付费但稳定）：
- Pinata Dedicated Gateway
- Infura IPFS Gateway
```

### 客户端

- **IPFS Desktop**：官方图形界面客户端
- **命令行**：`ipfs add`, `ipfs pin`, `ipfs get`

---

## 自测题

1. **概念理解**：为什么说 IPFS 是"内容寻址"而不是"地址寻址"？这有什么好处？

2. **风险识别**：你购买了一个 NFT，tokenURI 指向 `https://api.project.com/metadata/1`，这有什么风险？如果是 `ipfs://QmXxx...` 呢？

3. **实操判断**：你上传了一张图片到 IPFS 获得了 CID，然后发现图片有个错误想修改，应该怎么做？

<details>
<summary>参考答案</summary>

1. "地址寻址"是通过位置找内容（告诉你去哪台服务器的哪个路径），服务器可以随时换掉那个位置的内容。"内容寻址"是通过内容的哈希值（指纹）找内容，不管文件存在哪里，只要内容对得上就行。好处是：
   - 内容不可篡改（改了哈希就变了）
   - 可以从多个来源获取（不依赖单一服务器）
   - 可以验证完整性（下载后算哈希对比）

2. HTTP 链接的风险：
   - 项目方可以随时修改服务器上的内容
   - 服务器关闭后内容就访问不了
   - 你无法验证内容是否被篡改

   IPFS 链接相对安全：
   - 内容改变会导致 CID 变化
   - 可以从任何 IPFS 节点获取
   - 但仍需要有人 pin 这个文件才能持久

3. 在 IPFS 中，你不能"修改"已上传的文件。正确做法是：
   - 修改原图片
   - 重新上传到 IPFS
   - 获得新的 CID
   - 更新元数据中的 image 链接
   - 重新上传元数据获得新的元数据 CID
   - 如果 NFT 已铸造，元数据 CID 已写入合约，则无法更新（除非合约支持更新 tokenURI）

</details>
