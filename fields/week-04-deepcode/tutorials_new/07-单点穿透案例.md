# 单点穿透案例

> 跟着一个例子，走完 DeepCode 全流程

---

## 案例背景

### 要复现的论文

```
论文: BPR - Bayesian Personalized Ranking from Implicit Feedback
作者: Rendle et al.
场景: 推荐系统
核心贡献: 提出 BPR 损失函数，用于隐式反馈的个性化排序

简单说:
  用户看过的商品 > 没看过的商品
  通过这个"偏好对"来训练推荐模型
```

### 论文的核心公式

```
BPR 优化目标:

  L_BPR = ∑ -ln σ(x̂_uij) + λ||Θ||²
         (u,i,j)∈D

其中:
  - u: 用户
  - i: 正样本（用户交互过的物品）
  - j: 负样本（用户没交互过的物品）
  - x̂_uij = x̂_ui - x̂_uj: 正负样本得分差
  - σ: sigmoid 函数
  - Θ: 模型参数
  - λ: 正则化系数
```

---

## Phase 1: Blueprint 生成

### Step 1.1: Concept Agent 分析

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Concept Agent 输入                               │
└─────────────────────────────────────────────────────────────────────┘

论文内容 (摘要):
"We present a generic optimization criterion BPR-Opt for
personalized ranking that is the maximum posterior estimator derived
from a Bayesian analysis of the problem. We also provide a generic
learning algorithm for optimizing models with respect to BPR-Opt..."

┌─────────────────────────────────────────────────────────────────────┐
│                    Concept Agent 输出                               │
└─────────────────────────────────────────────────────────────────────┘

{
  "paper_category": "推荐系统",
  "core_contribution": "BPR 损失函数，用于隐式反馈排序学习",
  "methodology": {
    "type": "成对排序学习",
    "approach": "贝叶斯后验最大化"
  },
  "key_modules": [
    "用户/物品嵌入",
    "BPR 损失函数",
    "负采样策略",
    "SGD 优化器"
  ],
  "module_relationships": "嵌入 → 得分计算 → BPR损失 → 反向传播"
}
```

### Step 1.2: Algorithm Agent 分析

```
┌─────────────────────────────────────────────────────────────────────┐
│                   Algorithm Agent 输入                              │
└─────────────────────────────────────────────────────────────────────┘

论文内容 (第 4 节 - 算法部分):
"Algorithm 1: LearnBPR
1. initialize Θ
2. repeat
3.   draw (u, i, j) from Ds
4.   Θ ← Θ + α(σ(-x̂_uij) · ∂x̂_uij/∂Θ + λΘ)
5. until convergence"

实验设置 (第 5 节):
"We use embedding dimension of 64, learning rate 0.01,
regularization 0.001, batch size 256..."

┌─────────────────────────────────────────────────────────────────────┐
│                   Algorithm Agent 输出                              │
└─────────────────────────────────────────────────────────────────────┘

{
  "algorithms": [
    {
      "name": "BPR Loss",
      "formula": "L = -∑ log σ(x̂_ui - x̂_uj) + λ||Θ||²",
      "pseudocode": """
        def bpr_loss(pos_score, neg_score, reg_param, params):
            diff = pos_score - neg_score
            loss = -log(sigmoid(diff)).mean()
            reg_loss = reg_param * sum(p.norm() for p in params)
            return loss + reg_loss
      """
    },
    {
      "name": "Negative Sampling",
      "strategy": "uniform random sampling from non-interacted items"
    }
  ],
  "hyperparameters": {
    "embed_dim": 64,
    "learning_rate": 0.01,
    "regularization": 0.001,
    "batch_size": 256,
    "epochs": 100
  },
  "architecture": {
    "user_embedding": "nn.Embedding(num_users, embed_dim)",
    "item_embedding": "nn.Embedding(num_items, embed_dim)",
    "score_function": "dot product"
  }
}
```

### Step 1.3: Planning Agent 整合

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Planning Agent 输出                              │
│                      (Blueprint 蓝图)                               │
└─────────────────────────────────────────────────────────────────────┘
```

```yaml
complete_reproduction_plan:

  # ═══════════════════════════════════════════════════════════════════
  # Part 1: 文件结构
  # ═══════════════════════════════════════════════════════════════════
  file_structure:
    - path: "config.py"
      priority: 1
      description: "配置文件，包含所有超参数"

    - path: "data/dataset.py"
      priority: 2
      description: "数据集类，加载用户-物品交互数据"

    - path: "data/sampler.py"
      priority: 3
      description: "负采样器，生成 (u, i, j) 三元组"

    - path: "models/bpr_model.py"
      priority: 4
      description: "BPR 模型，包含嵌入层和得分计算"

    - path: "models/loss.py"
      priority: 5
      description: "BPR 损失函数"

    - path: "train.py"
      priority: 6
      description: "训练脚本"

    - path: "evaluate.py"
      priority: 7
      description: "评估脚本，计算 NDCG、HR 等指标"

  # ═══════════════════════════════════════════════════════════════════
  # Part 2: 组件规格
  # ═══════════════════════════════════════════════════════════════════
  implementation_components:

    - name: "BPRModel"
      file: "models/bpr_model.py"
      interface: |
        class BPRModel(nn.Module):
            def __init__(self, num_users, num_items, embed_dim)
            def forward(self, user_ids, pos_item_ids, neg_item_ids)
            def predict(self, user_ids, item_ids) -> scores

    - name: "BPRLoss"
      file: "models/loss.py"
      formula: "L = -mean(log(sigmoid(pos_score - neg_score)))"
      interface: |
        class BPRLoss(nn.Module):
            def forward(self, pos_score, neg_score) -> loss

    - name: "NegativeSampler"
      file: "data/sampler.py"
      interface: |
        class NegativeSampler:
            def sample(self, user_id, pos_item_ids) -> neg_item_id

  # ═══════════════════════════════════════════════════════════════════
  # Part 3: 验证方案
  # ═══════════════════════════════════════════════════════════════════
  validation_approach:
    - type: "unit_test"
      target: "BPRLoss"
      check: "loss > 0 for pos_score > neg_score"

    - type: "training_test"
      target: "train.py"
      check: "loss decreases over epochs"

    - type: "metric_test"
      target: "evaluate.py"
      check: "NDCG@10 > 0.1 after training"

  # ═══════════════════════════════════════════════════════════════════
  # Part 4: 环境配置
  # ═══════════════════════════════════════════════════════════════════
  environment_setup:
    python_version: "3.9+"
    dependencies:
      - torch>=2.0
      - numpy>=1.21
      - pandas>=1.5

  # ═══════════════════════════════════════════════════════════════════
  # Part 5: 实现策略
  # ═══════════════════════════════════════════════════════════════════
  implementation_strategy:
    phases:
      - name: "Foundation"
        files: ["config.py"]

      - name: "Data"
        files: ["data/dataset.py", "data/sampler.py"]

      - name: "Model"
        files: ["models/bpr_model.py", "models/loss.py"]

      - name: "Training"
        files: ["train.py", "evaluate.py"]
```

---

## Phase 2: Code 生成

### Step 2.1: 生成 config.py

```
┌─────────────────────────────────────────────────────────────────────┐
│                     生成 config.py                                  │
└─────────────────────────────────────────────────────────────────────┘

AI 上下文:
  - Blueprint (完整蓝图)
  - 当前任务: 生成 config.py

AI 生成:
```

```python
# config.py - 全局配置

class Config:
    # 数据配置
    data_path = "data/ratings.csv"
    train_ratio = 0.8

    # 模型配置
    embed_dim = 64
    num_users = 10000  # 将从数据中更新
    num_items = 5000   # 将从数据中更新

    # 训练配置
    learning_rate = 0.01
    regularization = 0.001
    batch_size = 256
    epochs = 100

    # 评估配置
    top_k = 10

config = Config()
```

```
CodeMem 更新:
┌─────────────────────────────────────────────────────────────────────┐
│ 文件: config.py                                                     │
│ 核心职责: 管理全局配置参数                                           │
│ 公开接口:                                                           │
│   - class Config                                                    │
│   - config (全局实例)                                               │
│ 依赖关系: 无                                                        │
└─────────────────────────────────────────────────────────────────────┘
```

### Step 2.2: 生成 data/dataset.py

```
┌─────────────────────────────────────────────────────────────────────┐
│                   生成 data/dataset.py                              │
└─────────────────────────────────────────────────────────────────────┘

AI 上下文:
  - Blueprint
  - CodeMem: config.py 的摘要

AI 生成:
```

```python
# data/dataset.py - 数据集加载

import pandas as pd
import numpy as np
from torch.utils.data import Dataset
from config import config

class BPRDataset(Dataset):
    """BPR 训练数据集"""

    def __init__(self, interactions_path: str):
        """
        Args:
            interactions_path: 用户-物品交互数据路径
        """
        self.df = pd.read_csv(interactions_path)
        self.users = self.df['user_id'].unique()
        self.items = self.df['item_id'].unique()

        # 更新配置
        config.num_users = len(self.users)
        config.num_items = len(self.items)

        # 构建用户->正样本物品映射
        self.user_pos_items = self._build_user_pos_items()

    def _build_user_pos_items(self):
        """构建用户的正样本物品集合"""
        user_pos = {}
        for _, row in self.df.iterrows():
            u = row['user_id']
            i = row['item_id']
            if u not in user_pos:
                user_pos[u] = set()
            user_pos[u].add(i)
        return user_pos

    def __len__(self):
        return len(self.df)

    def __getitem__(self, idx):
        row = self.df.iloc[idx]
        return row['user_id'], row['item_id']
```

```
CodeMem 更新:
┌─────────────────────────────────────────────────────────────────────┐
│ 文件: data/dataset.py                                               │
│ 核心职责: 加载用户-物品交互数据                                       │
│ 公开接口:                                                           │
│   - class BPRDataset(Dataset)                                       │
│   - __init__(self, interactions_path: str)                          │
│   - user_pos_items: Dict[int, Set[int]]                            │
│ 依赖关系:                                                           │
│   - 导入: config.py                                                 │
└─────────────────────────────────────────────────────────────────────┘
```

### Step 2.3: 生成 models/loss.py (使用 CodeRAG)

```
┌─────────────────────────────────────────────────────────────────────┐
│                   生成 models/loss.py                               │
│                   (触发 CodeRAG 检索)                               │
└─────────────────────────────────────────────────────────────────────┘

AI 思考:
  "BPR Loss 的具体实现方式，让我检索一下参考代码..."

AI 调用 CodeRAG:
  search_reference_code("BPR loss PyTorch implementation")

CodeRAG 返回:
┌─────────────────────────────────────────────────────────────────────┐
│ 参考代码 1 (来自 RecBole):                                          │
│                                                                     │
│ class BPRLoss(nn.Module):                                           │
│     def __init__(self):                                             │
│         super().__init__()                                          │
│                                                                     │
│     def forward(self, pos_score, neg_score):                        │
│         loss = -torch.log(torch.sigmoid(pos_score - neg_score))     │
│         return loss.mean()                                          │
└─────────────────────────────────────────────────────────────────────┘

AI 生成 (参考 CodeRAG 结果):
```

```python
# models/loss.py - BPR 损失函数

import torch
import torch.nn as nn

class BPRLoss(nn.Module):
    """
    Bayesian Personalized Ranking Loss

    公式: L = -mean(log(sigmoid(pos_score - neg_score)))
    """

    def __init__(self):
        super().__init__()

    def forward(self, pos_score: torch.Tensor, neg_score: torch.Tensor) -> torch.Tensor:
        """
        计算 BPR 损失

        Args:
            pos_score: 正样本得分 [batch_size]
            neg_score: 负样本得分 [batch_size]

        Returns:
            标量损失值
        """
        diff = pos_score - neg_score
        loss = -torch.log(torch.sigmoid(diff) + 1e-8)  # 添加 eps 防止 log(0)
        return loss.mean()
```

### Step 2.4: 生成 train.py (使用 CodeMem)

```
┌─────────────────────────────────────────────────────────────────────┐
│                     生成 train.py                                   │
│                   (使用 CodeMem 接口)                               │
└─────────────────────────────────────────────────────────────────────┘

AI 上下文:
  - Blueprint
  - CodeMem (所有已生成文件的摘要):
    - config.py: config 实例，包含 embed_dim, learning_rate 等
    - dataset.py: BPRDataset 类
    - sampler.py: NegativeSampler 类
    - bpr_model.py: BPRModel 类，forward(user, pos, neg)
    - loss.py: BPRLoss 类，forward(pos_score, neg_score)

AI 生成:
```

```python
# train.py - 训练脚本

import torch
import torch.optim as optim
from torch.utils.data import DataLoader

from config import config
from data.dataset import BPRDataset
from data.sampler import NegativeSampler
from models.bpr_model import BPRModel
from models.loss import BPRLoss

def train():
    # 加载数据
    dataset = BPRDataset(config.data_path)
    dataloader = DataLoader(dataset, batch_size=config.batch_size, shuffle=True)
    sampler = NegativeSampler(dataset.user_pos_items, config.num_items)

    # 初始化模型
    model = BPRModel(
        num_users=config.num_users,
        num_items=config.num_items,
        embed_dim=config.embed_dim
    )

    # 损失和优化器
    criterion = BPRLoss()
    optimizer = optim.Adam(
        model.parameters(),
        lr=config.learning_rate,
        weight_decay=config.regularization
    )

    # 训练循环
    for epoch in range(config.epochs):
        total_loss = 0
        for user_ids, pos_item_ids in dataloader:
            # 负采样
            neg_item_ids = sampler.sample_batch(user_ids, pos_item_ids)

            # 前向传播
            pos_score, neg_score = model(user_ids, pos_item_ids, neg_item_ids)

            # 计算损失
            loss = criterion(pos_score, neg_score)

            # 反向传播
            optimizer.zero_grad()
            loss.backward()
            optimizer.step()

            total_loss += loss.item()

        avg_loss = total_loss / len(dataloader)
        print(f"Epoch {epoch+1}/{config.epochs}, Loss: {avg_loss:.4f}")

    # 保存模型
    torch.save(model.state_dict(), "bpr_model.pth")
    print("Training complete!")

if __name__ == "__main__":
    train()
```

---

## Phase 3: Verification 验证

### Step 3.1: 第一次运行

```
┌─────────────────────────────────────────────────────────────────────┐
│                     运行 python train.py                            │
└─────────────────────────────────────────────────────────────────────┘

错误信息:
Traceback (most recent call last):
  File "train.py", line 7, in <module>
    from data.sampler import NegativeSampler
ImportError: No module named 'data.sampler'
```

### Step 3.2: 分析和修复

```
┌─────────────────────────────────────────────────────────────────────┐
│                        错误分析                                     │
└─────────────────────────────────────────────────────────────────────┘

AI 分析:
  错误类型: ImportError
  原因: data 目录缺少 __init__.py 文件，不是一个 Python 包

修复方案:
  创建 data/__init__.py 文件

执行修复:
  touch data/__init__.py
  touch models/__init__.py
```

### Step 3.3: 第二次运行

```
┌─────────────────────────────────────────────────────────────────────┐
│                    再次运行 python train.py                          │
└─────────────────────────────────────────────────────────────────────┘

错误信息:
Traceback (most recent call last):
  File "train.py", line 18, in train
    dataset = BPRDataset(config.data_path)
FileNotFoundError: [Errno 2] No such file or directory: 'data/ratings.csv'
```

### Step 3.4: 分析和修复

```
┌─────────────────────────────────────────────────────────────────────┐
│                        错误分析                                     │
└─────────────────────────────────────────────────────────────────────┘

AI 分析:
  错误类型: FileNotFoundError
  原因: 没有训练数据文件

修复方案:
  创建示例数据文件用于测试

执行修复:
```

```python
# 创建 create_sample_data.py
import pandas as pd
import numpy as np

np.random.seed(42)
users = np.random.randint(0, 100, 1000)
items = np.random.randint(0, 50, 1000)
df = pd.DataFrame({'user_id': users, 'item_id': items})
df.to_csv('data/ratings.csv', index=False)
```

### Step 3.5: 第三次运行

```
┌─────────────────────────────────────────────────────────────────────┐
│                    再次运行 python train.py                          │
└─────────────────────────────────────────────────────────────────────┘

输出:
Epoch 1/100, Loss: 0.6931
Epoch 2/100, Loss: 0.6842
Epoch 3/100, Loss: 0.6753
...
Epoch 100/100, Loss: 0.4521
Training complete!

✅ 成功！
```

---

## 最终产出

### 生成的代码仓库

```
generate_code/
├── config.py                 # 配置文件
├── data/
│   ├── __init__.py
│   ├── dataset.py           # 数据集类
│   ├── sampler.py           # 负采样器
│   └── ratings.csv          # 示例数据
├── models/
│   ├── __init__.py
│   ├── bpr_model.py         # BPR 模型
│   └── loss.py              # BPR 损失函数
├── train.py                  # 训练脚本
├── evaluate.py               # 评估脚本
└── requirements.txt          # 依赖列表
```

### 验证结果

```
┌─────────────────────────────────────────────────────────────────────┐
│                        验证结果                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ✅ 语法检查: 通过                                                  │
│  ✅ 导入测试: 通过                                                  │
│  ✅ 训练测试: Loss 在 100 个 epoch 后下降 35%                       │
│  ✅ 评估测试: NDCG@10 = 0.23 (> 0.1 基准)                          │
│                                                                     │
│  总耗时: 3 分钟                                                     │
│  迭代次数: 3 次                                                     │
│  生成文件: 9 个                                                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 关键点回顾

### 流程总结

```
┌────────────────────────────────────────────────────────────────────┐
│                       流程回顾                                      │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  Phase 1: Blueprint                                                │
│  ────────────────                                                  │
│  • Concept Agent 提取宏观结构                                       │
│  • Algorithm Agent 提取技术细节                                     │
│  • Planning Agent 生成完整蓝图                                      │
│                                                                    │
│  Phase 2: Code Generation                                          │
│  ────────────────────────                                          │
│  • 按优先级生成每个文件                                             │
│  • CodeMem 记录接口，保持一致性                                     │
│  • CodeRAG 检索参考代码，填补空白                                   │
│                                                                    │
│  Phase 3: Verification                                             │
│  ─────────────────────                                             │
│  • 运行代码发现错误                                                 │
│  • 分析错误原因                                                     │
│  • 生成修复并重试                                                   │
│  • 迭代直到成功                                                     │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

### 各组件的作用

| 组件 | 在案例中的作用 |
|------|--------------|
| **Blueprint** | 把论文转换为 7 个文件的实现计划 |
| **CodeMem** | 记住 config、dataset 等已生成文件的接口 |
| **CodeRAG** | 检索 BPR Loss 的参考实现 |
| **Verification** | 发现并修复 ImportError 和 FileNotFoundError |

---

## 恭喜！

你已经完成了 DeepCode 的完整学习！

### 你学到了

```
✅ WHY    - 为什么需要 DeepCode（信息流管理问题）
✅ WHAT   - DeepCode 的完整流程（三个阶段）
✅ 核心概念 - Blueprint、CodeMem、CodeRAG、Verification
✅ HOW    - 一个完整的实战案例
```

### 下一步

1. **尝试使用**: 用 DeepCode 复现你感兴趣的论文
2. **阅读代码**: 深入研究 `workflows/` 目录下的实现
3. **贡献改进**: 提交 Issue 或 PR，帮助改进 DeepCode

---

## 附录：代码文件对照

| 概念 | 代码文件 | 核心类/函数 |
|------|---------|------------|
| Blueprint | `prompts/code_prompts.py` | PAPER_*_PROMPT |
| CodeMem | `workflows/agents/memory_agent_concise.py` | ConciseMemoryAgent |
| CodeRAG | `tools/code_indexer.py` | CodeIndexer |
| Verification | `workflows/code_implementation_workflow.py` | verify_code() |
| 主流程 | `workflows/agent_orchestration_engine.py` | AgentOrchestrationEngine |

---

*教程完成！如有问题，欢迎在 GitHub 上提 Issue。*
