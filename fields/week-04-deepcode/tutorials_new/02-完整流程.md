# DeepCode 完整流程

> 从论文到代码，每一步都讲清楚

---

## 流程总览

### 一图看懂全流程

```
     输入                Phase 1              Phase 2              Phase 3              输出
┌──────────┐        ┌──────────────┐      ┌──────────────┐      ┌──────────────┐    ┌──────────┐
│   论文   │  ────▶ │   Blueprint  │ ───▶ │     Code     │ ───▶ │ Verification │ ─▶ │   代码   │
│  (PDF)   │        │   生成蓝图   │      │   生成代码   │      │   验证修复   │    │   仓库   │
└──────────┘        └──────────────┘      └──────────────┘      └──────────────┘    └──────────┘
                           │                     │                     │
                           ▼                     ▼                     ▼
                    ┌──────────────┐      ┌──────────────┐      ┌──────────────┐
                    │ • Concept    │      │ • CodeMem    │      │ • 错误检测   │
                    │   Agent      │      │ • CodeRAG    │      │ • 自动修复   │
                    │ • Algorithm  │      │ • LLM 生成   │      │ • 迭代验证   │
                    │   Agent      │      │              │      │              │
                    │ • Planning   │      │              │      │              │
                    │   Agent      │      │              │      │              │
                    └──────────────┘      └──────────────┘      └──────────────┘
```

### 每个阶段的输入输出

| 阶段 | 输入 | 加工 | 输出 |
|------|------|------|------|
| **Phase 1** | 论文 PDF | 多 Agent 分析 | 结构化蓝图 |
| **Phase 2** | 蓝图 | 迭代生成 + 记忆 + 检索 | 代码文件 |
| **Phase 3** | 代码文件 | 运行 + 检测 + 修复 | 可运行仓库 |

---

## Phase 1: Blueprint 生成

### 目标

**把杂乱的论文变成清晰的实现计划**

### 为什么需要这一步？

```
论文原样:
┌────────────────────────────────────────────────────────────┐
│ Section 1: Introduction                                    │
│   我们提出了一个创新的方法...                               │
│                                                            │
│ Section 2: Related Work                                    │
│   之前的方法有 A、B、C...                                   │
│                                                            │
│ Section 3: Method                                          │
│   3.1 我们的模型架构是...                                   │
│   3.2 训练过程使用...                                       │
│   公式: L = -∑ log σ(y_ui - y_uj) + λ||Θ||²               │
│                                                            │
│ Section 4: Experiments                                     │
│   数据集: MovieLens, Yelp...                               │
│   超参数在附录 A 中...                                      │
└────────────────────────────────────────────────────────────┘

问题：
  - 信息散落各处
  - 没有明确的实现步骤
  - 不知道先写什么、后写什么
```

### 三个 Agent 协作

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Phase 1: Blueprint 生成                        │
└─────────────────────────────────────────────────────────────────────────┘

            论文内容
                │
    ┌───────────┴───────────┐
    ▼                       ▼
┌────────────┐         ┌────────────┐
│ Concept    │         │ Algorithm  │
│ Agent      │         │ Agent      │
│            │         │            │
│ 宏观理解   │         │ 微观细节   │
│ • 核心贡献 │         │ • 算法步骤 │
│ • 模块划分 │         │ • 数学公式 │
│ • 整体架构 │         │ • 超参数   │
└─────┬──────┘         └─────┬──────┘
      │                      │
      └──────────┬───────────┘
                 ▼
          ┌────────────┐
          │ Planning   │
          │ Agent      │
          │            │
          │ 整合规划   │
          │ 生成蓝图   │
          └─────┬──────┘
                │
                ▼
          ┌────────────┐
          │ Blueprint  │
          │ 实现蓝图   │
          └────────────┘
```

### Blueprint 包含什么？

```yaml
# Blueprint 结构示例

complete_reproduction_plan:

  # 1. 项目文件结构
  file_structure:
    - path: "config.py"
      priority: 1
      description: "配置参数管理"
    - path: "data/dataset.py"
      priority: 2
      description: "数据加载和预处理"
    - path: "models/encoder.py"
      priority: 3
      description: "编码器模块"
    ...

  # 2. 组件规格
  implementation_components:
    - name: "BPR Loss"
      file: "models/loss.py"
      algorithm: "Bayesian Personalized Ranking Loss"
      formula: "L = -∑ log σ(y_ui - y_uj)"

  # 3. 验证方案
  validation_approach:
    - type: "unit_test"
      target: "loss function"
    - type: "integration"
      target: "full pipeline"

  # 4. 环境配置
  environment_setup:
    python_version: "3.9"
    dependencies:
      - torch>=2.0
      - numpy>=1.21

  # 5. 实现策略
  implementation_strategy:
    phases:
      - name: "Foundation"
        files: ["config.py", "utils.py"]
      - name: "Core"
        files: ["encoder.py", "model.py"]
```

---

## Phase 2: Code 生成

### 目标

**根据蓝图，一个文件一个文件地生成代码**

### 核心挑战

```
问题：生成第 10 个文件时，需要知道前 9 个文件都写了什么

方案 1（失败）：把所有代码都塞进 prompt
  → 超出上下文窗口限制

方案 2（DeepCode）：用 CodeMem 记住"摘要"
  → 只保留关键接口信息，不保留完整代码
```

### 双引擎驱动

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Phase 2: Code 生成                              │
└─────────────────────────────────────────────────────────────────────────┘

                         ┌────────────────┐
                         │   Blueprint    │
                         │   (实现蓝图)    │
                         └───────┬────────┘
                                 │
                                 ▼
              ┌──────────────────────────────────────┐
              │         迭代生成循环                  │
              │   for file in blueprint.files:       │
              │                                      │
              │     ┌───────────────────────────┐   │
              │     │     构建上下文            │   │
              │     │     Context =             │   │
              │     │       Blueprint +         │   │
              │     │       CodeMem.get(...) +  │   │
              │     │       CodeRAG.search(...) │   │
              │     └─────────────┬─────────────┘   │
              │                   │                  │
              │                   ▼                  │
              │     ┌───────────────────────────┐   │
              │     │     LLM 生成代码          │   │
              │     │     code = LLM(context)   │   │
              │     └─────────────┬─────────────┘   │
              │                   │                  │
              │                   ▼                  │
              │     ┌───────────────────────────┐   │
              │     │     更新 CodeMem          │   │
              │     │     CodeMem.add(code)     │   │
              │     └───────────────────────────┘   │
              │                                      │
              └──────────────────────────────────────┘
                                 │
            ┌────────────────────┼────────────────────┐
            │                    │                    │
            ▼                    ▼                    ▼
     ┌────────────┐       ┌────────────┐       ┌────────────┐
     │  CodeMem   │       │  CodeRAG   │       │    LLM     │
     │  代码记忆  │       │  知识检索  │       │  生成引擎  │
     │            │       │            │       │            │
     │ 记住已生成 │       │ 检索参考   │       │ 生成代码   │
     │ 的文件接口 │       │ 代码模式   │       │            │
     └────────────┘       └────────────┘       └────────────┘
```

### CodeMem 怎么工作？

```
原始代码 (500 tokens):
┌─────────────────────────────────────────────────────────────┐
│ class DataLoader:                                           │
│     def __init__(self, path, batch_size):                   │
│         self.path = path                                    │
│         self.batch_size = batch_size                        │
│         self.data = []                                      │
│         ...（省略 100 行）                                   │
│                                                             │
│     def load(self):                                         │
│         ...（省略 50 行）                                    │
│                                                             │
│     def batch(self, size):                                  │
│         ...（省略 30 行）                                    │
└─────────────────────────────────────────────────────────────┘

                    ↓ CodeMem 压缩

Memory Entry (50 tokens):
┌─────────────────────────────────────────────────────────────┐
│ 文件: data/dataset.py                                       │
│                                                             │
│ 核心职责: 加载和批处理训练数据                               │
│                                                             │
│ 公开接口:                                                   │
│   - class DataLoader(path, batch_size)                      │
│   - load() -> List[Dict]                                    │
│   - batch(size) -> Iterator                                 │
│                                                             │
│ 依赖关系:                                                   │
│   - 导入: config.py, utils.py                               │
│   - 被导入: train.py, evaluate.py                           │
└─────────────────────────────────────────────────────────────┘

压缩率: 10:1
```

### CodeRAG 怎么工作？

```
场景：论文说"使用 BPR Loss"，但没给具体代码

┌─────────────────────────────────────────────────────────────┐
│                       CodeRAG 检索流程                       │
└─────────────────────────────────────────────────────────────┘

Step 1: 发起查询
        Query: "BPR Loss PyTorch implementation"
                           │
                           ▼
Step 2: 搜索索引
        ┌──────────────────────────────────────────┐
        │  参考代码库索引                          │
        │  ├── recbole/bpr_loss.py (相似度: 0.95) │
        │  ├── lightfm/loss.py (相似度: 0.82)     │
        │  └── surprise/bpr.py (相似度: 0.71)     │
        └──────────────────────────────────────────┘
                           │
                           ▼
Step 3: 返回参考代码
        ┌──────────────────────────────────────────┐
        │  # recbole/bpr_loss.py                   │
        │  class BPRLoss(nn.Module):               │
        │      def forward(self, pos, neg):        │
        │          return -torch.log(              │
        │              torch.sigmoid(pos - neg)    │
        │          ).mean()                        │
        └──────────────────────────────────────────┘
                           │
                           ▼
Step 4: 注入上下文
        LLM 看到：蓝图 + CodeMem + 参考代码
        → 生成更准确的实现
```

---

## Phase 3: Verification 验证

### 目标

**确保生成的代码能够正确运行**

### 验证循环

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Phase 3: Verification                            │
└─────────────────────────────────────────────────────────────────────────┘

                    ┌────────────────┐
                    │   代码文件     │
                    │   集合         │
                    └───────┬────────┘
                            │
                            ▼
          ┌──────────────────────────────────────────┐
          │              验证循环                     │
          │                                          │
          │    ┌───────────────────────────────┐    │
          │    │         运行代码              │    │
          │    │   python train.py             │    │
          │    └─────────────┬─────────────────┘    │
          │                  │                       │
          │                  ▼                       │
          │    ┌───────────────────────────────┐    │
          │    │         检测错误              │    │
          │    │   分析 stdout/stderr          │    │
          │    └─────────────┬─────────────────┘    │
          │                  │                       │
          │         ┌────────┴────────┐             │
          │         │                 │             │
          │         ▼                 ▼             │
          │    ┌─────────┐       ┌─────────┐        │
          │    │ 有错误  │       │ 无错误  │        │
          │    └────┬────┘       └────┬────┘        │
          │         │                 │             │
          │         ▼                 │             │
          │    ┌─────────────────┐    │             │
          │    │ 生成修复指导    │    │             │
          │    │ + 修改代码      │    │             │
          │    └────────┬────────┘    │             │
          │             │             │             │
          │             └──────┬──────┘             │
          │                    │                     │
          │                    ▼                     │
          │         ┌───────────────────┐           │
          │         │ 是否达到最大重试? │           │
          │         └─────────┬─────────┘           │
          │                   │                      │
          │       NO ←────────┴────────→ YES        │
          │        │                      │          │
          │        └─────(继续循环)       │          │
          │                               │          │
          └───────────────────────────────┘          │
                                                     │
                                                     ▼
                              ┌────────────────────────────────┐
                              │       输出结果                 │
                              │   成功: 可运行的代码仓库       │
                              │   失败: 报告未解决的问题       │
                              └────────────────────────────────┘
```

### 错误修复示例

```
第 1 次运行:
  $ python train.py
  Error: ModuleNotFoundError: No module named 'numpy'

  修复: 添加 numpy 到 requirements.txt
        pip install numpy

───────────────────────────────────────────

第 2 次运行:
  $ python train.py
  Error: TypeError: forward() missing 1 required argument: 'mask'

  修复: 检查 forward 方法签名
        添加 mask 参数的默认值

───────────────────────────────────────────

第 3 次运行:
  $ python train.py
  Training started...
  Epoch 1: loss = 0.523
  ...
  Success!
```

---

## 完整时序图

```
时间轴 →
────────────────────────────────────────────────────────────────────────────

论文 PDF                                                           代码仓库
    │                                                                  ▲
    │                                                                  │
    ▼                                                                  │
┌───────────────────────────────────────────────────────────────────────┐
│                                                                       │
│  Phase 1                                                              │
│  ────────                                                             │
│    │                                                                  │
│    ├─→ Concept Agent 分析                                            │
│    │       "这是推荐系统论文，核心是 BPR 方法"                         │
│    │                                                                  │
│    ├─→ Algorithm Agent 分析                                           │
│    │       "Loss = -∑ log σ(...), lr=0.001, embed_dim=64"            │
│    │                                                                  │
│    └─→ Planning Agent 整合                                            │
│            → 生成 Blueprint                                           │
│                                                                       │
├───────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  Phase 2                                                              │
│  ────────                                                             │
│    │                                                                  │
│    ├─→ 生成 config.py                                                │
│    │       CodeMem: 记录接口                                         │
│    │                                                                  │
│    ├─→ 生成 data/dataset.py                                          │
│    │       CodeMem: 更新                                              │
│    │       CodeRAG: 检索数据加载参考                                  │
│    │                                                                  │
│    ├─→ 生成 models/bpr_model.py                                      │
│    │       CodeMem: 更新                                              │
│    │       CodeRAG: 检索 BPR Loss 参考                                │
│    │                                                                  │
│    └─→ 生成 train.py                                                 │
│            CodeMem: 读取之前的接口                                    │
│            → 完成代码生成                                             │
│                                                                       │
├───────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  Phase 3                                                              │
│  ────────                                                             │
│    │                                                                  │
│    ├─→ 运行 train.py → 发现错误                                      │
│    ├─→ 自动修复                                                       │
│    ├─→ 再次运行 → 发现错误                                           │
│    ├─→ 自动修复                                                       │
│    └─→ 再次运行 → 成功！                                              │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
                                                                       │
                                                                       ▼
                                                               generate_code/
                                                               ├── config.py
                                                               ├── data/
                                                               │   └── dataset.py
                                                               ├── models/
                                                               │   └── bpr_model.py
                                                               ├── train.py
                                                               └── requirements.txt
```

---

## 代码文件对照

| 流程阶段 | 代码文件 | 核心函数/类 |
|---------|---------|------------|
| **Phase 1** | `agent_orchestration_engine.py` | `execute_multi_agent_research_pipeline()` |
| Concept Agent | `prompts/code_prompts.py` | `PAPER_CONCEPT_ANALYSIS_PROMPT` |
| Algorithm Agent | `prompts/code_prompts.py` | `PAPER_ALGORITHM_ANALYSIS_PROMPT` |
| Planning Agent | `prompts/code_prompts.py` | `CODE_PLANNING_PROMPT` |
| **Phase 2** | `code_implementation_workflow.py` | `_pure_code_implementation_loop()` |
| CodeMem | `agents/memory_agent_concise.py` | `ConciseMemoryAgent` |
| CodeRAG | `tools/code_indexer.py` | `CodeIndexer` |
| **Phase 3** | `code_implementation_workflow.py` | `_check_tool_results_for_errors()` |

---

## 小结

```
Phase 1: Blueprint 生成
  输入: 论文
  处理: 3个Agent协作分析
  输出: 结构化的实现蓝图

Phase 2: Code 生成
  输入: Blueprint
  处理: 迭代生成，用 CodeMem 记忆，用 CodeRAG 检索
  输出: 代码文件集合

Phase 3: Verification 验证
  输入: 代码文件
  处理: 运行→检测→修复，循环直到成功
  输出: 可运行的代码仓库
```

---

## 下一步

现在你理解了完整流程。接下来我们深入每个核心概念：

- **→ [03-Blueprint蓝图.md](./03-Blueprint蓝图.md)** — Phase 1 的核心
- **→ [04-CodeMem代码记忆.md](./04-CodeMem代码记忆.md)** — Phase 2 的引擎之一
- **→ [05-CodeRAG知识检索.md](./05-CodeRAG知识检索.md)** — Phase 2 的引擎之二
- **→ [06-Verification验证.md](./06-Verification验证.md)** — Phase 3 的核心
